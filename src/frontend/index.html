<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Icarus - PowerShell-Inspired Blade Navigation</title>
    
    <!-- External Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    
    <style>
        /* Variables */
        :root {
            /* PowerShell Dark Theme Colors */
            --bg-primary: #012456;
            --bg-secondary: #001122;
            --bg-tertiary: #1a1a2e;
            --bg-hover: #003366;
            --bg-active: #004080;
            
            /* Text Colors */
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-muted: #808080;
            --text-bright: #00FFFF;
            
            /* Azure Theme Colors */
            --azure-blue: #0078D4;
            --azure-dark: #005A9E;
            --azure-light: #40E0D0;
            --azure-accent: #00BCF2;
            
            /* Status Colors */
            --success-green: #16C60C;
            --success-dark: #0E7C08;
            --warning-orange: #FFC107;
            --warning-dark: #F9A825;
            --error-red: #F44336;
            --error-dark: #D32F2F;
            --info-blue: #2196F3;
            
            /* Border and Shadow */
            --border-primary: #2A2A3E;
            --border-secondary: #3A3A4E;
            --shadow-primary: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Cascadia Code', 'Monaco', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        #root {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-secondary);
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--azure-blue);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-primary);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Main Content Area */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Navigation Sidebar */
        .nav-sidebar {
            width: 280px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .nav-section {
            padding: 15px;
            border-bottom: 1px solid var(--border-primary);
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .workflow-btn {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .workflow-btn:hover {
            background: var(--bg-hover);
            border-color: var(--azure-light);
            box-shadow: var(--shadow-hover);
        }

        .workflow-btn.active {
            background: var(--azure-dark);
            border-color: var(--azure-light);
        }

        /* Sub-navigation for workflow steps */
        .workflow-steps {
            margin-top: 10px;
            padding-left: 20px;
        }

        .step-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .step-btn {
            width: calc(100% - 10px);
            padding: 8px 12px;
            margin-bottom: 5px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            border-radius: 3px;
            text-align: left;
        }

        .step-btn:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--azure-accent);
        }

        .step-btn.active {
            background: var(--azure-blue);
            color: var(--text-primary);
            border-color: var(--azure-light);
        }

        .step-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        /* Blade Content Styles */
        .blade-content {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .blade-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-primary);
        }

        .blade-icon {
            font-size: 32px;
        }

        .blade-title-section h2 {
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .blade-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Sections */
        .section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-select, .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            background: #FFFFFF;
            color: #000000;
            border: 2px solid var(--azure-dark);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--azure-light);
        }

        .form-textarea {
            min-height: 200px;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--azure-dark);
            color: white;
        }

        .btn-primary:hover {
            background: var(--azure-blue);
        }

        .btn-success {
            background: var(--success-dark);
            color: white;
        }

        .btn-success:hover {
            background: var(--success-green);
        }

        .btn-warning {
            background: var(--warning-dark);
            color: white;
        }

        .btn-warning:hover {
            background: var(--warning-orange);
        }

        .btn-danger {
            background: var(--error-dark);
            color: white;
        }

        .btn-danger:hover {
            background: var(--error-red);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Right Status Panel */
        .status-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-primary);
            padding: 20px;
            overflow-y: auto;
        }

        .session-info {
            margin-bottom: 25px;
        }

        .info-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item {
            margin-bottom: 12px;
        }

        .info-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .info-value.success {
            color: var(--success-green);
        }

        .info-value.warning {
            color: var(--warning-orange);
        }

        .info-value.error {
            color: var(--error-red);
        }

        /* Token Budget Display */
        .token-budget {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .budget-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .budget-label {
            color: var(--text-secondary);
        }

        .budget-value {
            color: var(--azure-light);
            font-weight: 600;
        }

        /* Activity Status */
        .activity-status {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .activity-status.active {
            border-color: var(--success-green);
            color: var(--success-green);
        }

        /* Results Display */
        .results-container {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .results-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .results-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .results-content pre {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Success Message */
        .success-message {
            background: var(--success-dark);
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Error Message */
        .error-message {
            background: var(--error-dark);
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-primary);
            border-top-color: var(--azure-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Entity and Severity Badges */
        .entity-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-high, .severity-critical {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error-red);
            border: 1px solid var(--error-red);
        }

        .severity-medium {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning-orange);
            border: 1px solid var(--warning-orange);
        }

        .severity-low, .severity-informational {
            background: rgba(33, 150, 243, 0.2);
            color: var(--info-blue);
            border: 1px solid var(--info-blue);
        }
        
        .spinner-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #0066cc;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Progress Bar */
        .progress-bar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--azure-dark), var(--azure-light));
            transition: width 0.3s ease;
        }

        /* Quota Display */
        .quota-info {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .quota-title {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .quota-value {
            font-size: 18px;
            color: var(--azure-light);
            font-weight: 700;
        }

        .quota-details {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Metrics Display */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .metric-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 10px;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .metric-value {
            color: var(--azure-light);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Initialize MSAL globally before React -->
    <script>
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: 'ecba9fbd-dc5b-472d-bcec-c2a0b6a67304',
                authority: 'https://login.microsoftonline.com/a30b4895-7840-4802-8694-7ad40d5d2551',
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            },
            system: {
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) return;
                        switch (level) {
                            case 0: console.error(message); break;
                            case 1: console.warn(message); break;
                            case 2: console.info(message); break;
                            case 3: console.debug(message); break;
                        }
                    }
                }
            }
        };

        // Create MSAL instance globally
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        window.msalInstance = msalInstance; // Make available for debugging

        // Initialize MSAL
        msalInstance.initialize().then(() => {
            console.log('MSAL initialized successfully');
            
            // Handle redirect promise
            msalInstance.handleRedirectPromise().then(response => {
                if (response) {
                    console.log('Redirect response received:', response);
                    msalInstance.setActiveAccount(response.account);
                }
            }).catch(error => {
                console.error('Redirect error:', error);
            });
        });

        // Global token acquisition helper with proper error handling
        window.acquireTokenSafe = async (scopes = ['openid', 'profile', 'User.Read']) => {
            try {
                // Simple delay to avoid concurrent calls
                if (window.tokenAcquisitionInProgress) {
                    // Wait for the previous call to complete
                    let attempts = 0;
                    while (window.tokenAcquisitionInProgress && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    if (window.tokenAcquisitionInProgress) {
                        throw new Error('Token acquisition timeout');
                    }
                }
                
                window.tokenAcquisitionInProgress = true;

                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    window.tokenAcquisitionInProgress = false;
                    throw new Error('No accounts found - please login first');
                }

                // Set active account if not set
                if (!msalInstance.getActiveAccount()) {
                    msalInstance.setActiveAccount(accounts[0]);
                }

                try {
                    // Try silent acquisition first
                    const response = await msalInstance.acquireTokenSilent({
                        scopes,
                        account: accounts[0]
                    });
                    window.tokenAcquisitionInProgress = false;
                    return response.accessToken;
                } catch (silentError) {
                    console.log('Silent token acquisition failed, trying popup');
                    
                    try {
                        const response = await msalInstance.acquireTokenPopup({
                            scopes,
                            account: accounts[0]
                        });
                        window.tokenAcquisitionInProgress = false;
                        return response.accessToken;
                    } catch (popupError) {
                        window.tokenAcquisitionInProgress = false;
                        throw popupError;
                    }
                }
            } catch (error) {
                window.tokenAcquisitionInProgress = false;
                console.error('Token acquisition error:', error);
                throw error;
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Alert Card Component - Separated to fix React hooks issue
        const AlertCard = ({ alert, idx }) => {
            const [isExpanded, setIsExpanded] = React.useState(false);
            
            return (
                <div style={{
                    background: 'var(--bg-secondary)',
                    border: '1px solid var(--border-primary)',
                    borderRadius: '4px',
                    padding: '15px',
                    marginBottom: '15px'
                }}>
                    {/* Alert Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                        <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <h4 style={{ color: 'var(--text-bright)', margin: 0 }}>{alert.title || alert.name}</h4>
                                <button
                                    onClick={() => setIsExpanded(!isExpanded)}
                                    style={{
                                        background: 'var(--bg-tertiary)',
                                        border: '1px solid var(--border-primary)',
                                        borderRadius: '4px',
                                        padding: '2px 8px',
                                        cursor: 'pointer',
                                        fontSize: '12px',
                                        color: 'var(--text-secondary)'
                                    }}
                                >
                                    {isExpanded ? '▼ Collapse' : '▶ Expand Details'}
                                </button>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginTop: '5px' }}>
                                <span style={{ fontSize: '12px', color: 'var(--text-secondary)', fontFamily: 'monospace' }}>
                                    Alert ID: {alert.id || alert.alertId || 'N/A'}
                                </span>
                                {(alert.id || alert.alertId) && (
                                    <button
                                        onClick={(event) => {
                                            navigator.clipboard.writeText(alert.id || alert.alertId);
                                            event.target.textContent = '✓';
                                            setTimeout(() => {
                                                event.target.textContent = '📋';
                                            }, 1500);
                                        }}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            cursor: 'pointer',
                                            fontSize: '14px',
                                            padding: '2px'
                                        }}
                                        title="Copy Alert ID"
                                    >
                                        📋
                                    </button>
                                )}
                            </div>
                        </div>
                        <span style={{
                            background: alert.severity === 'high' ? '#ff4444' : 
                                       alert.severity === 'medium' ? '#ff8844' : 
                                       alert.severity === 'low' ? '#ffaa44' : '#888888',
                            color: 'white',
                            padding: '2px 8px',
                            borderRadius: '4px',
                            fontSize: '12px',
                            textTransform: 'uppercase'
                        }}>
                            {alert.severity || 'Unknown'}
                        </span>
                    </div>
                    
                    {/* Basic Info */}
                    <div style={{ color: 'var(--text-secondary)', fontSize: '13px', marginBottom: '10px' }}>
                        <div>Category: {alert.category || 'N/A'}</div>
                        <div>Status: {alert.status || 'N/A'}</div>
                        <div>Created: {alert.createdDateTime ? new Date(alert.createdDateTime).toLocaleString() : 'N/A'}</div>
                        <div>Provider: {alert.providerAlertId || alert.serviceSource || 'N/A'}</div>
                    </div>
                    
                    {/* Expandable Detailed Sections */}
                    {isExpanded && (
                        <div style={{ 
                            marginTop: '15px', 
                            paddingTop: '15px', 
                            borderTop: '1px solid var(--border-primary)' 
                        }}>
                            {/* MITRE ATT&CK Section */}
                            {(alert.mitreTechniques || alert.tactics) && (
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🎯 MITRE ATT&CK Mapping</h5>
                                    <div style={{ background: 'var(--bg-primary)', padding: '10px', borderRadius: '4px' }}>
                                        {alert.mitreTechniques && (
                                            <div style={{ marginBottom: '5px' }}>
                                                <strong>Techniques:</strong> {Array.isArray(alert.mitreTechniques) ? alert.mitreTechniques.join(', ') : alert.mitreTechniques}
                                            </div>
                                        )}
                                        {alert.tactics && (
                                            <div>
                                                <strong>Tactics:</strong> {Array.isArray(alert.tactics) ? alert.tactics.join(', ') : alert.tactics}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* Detection Information */}
                            {(alert.detectionSource || alert.detectorId) && (
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🔍 Detection Information</h5>
                                    <div style={{ background: 'var(--bg-primary)', padding: '10px', borderRadius: '4px' }}>
                                        <div>Source: {alert.detectionSource || alert.detectorId || 'N/A'}</div>
                                        <div>Confidence: {alert.confidence || 'N/A'}</div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Evidence */}
                            {alert.evidence && alert.evidence.length > 0 && (
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>📋 Evidence</h5>
                                    <div style={{ background: 'var(--bg-primary)', padding: '10px', borderRadius: '4px' }}>
                                        {alert.evidence.map((item, i) => (
                                            <div key={i} style={{ marginBottom: '5px' }}>
                                                {typeof item === 'object' ? JSON.stringify(item) : item}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Recommended Actions */}
                            {alert.recommendedActions && (
                                <div style={{ marginBottom: '15px' }}>
                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🛠️ Recommended Actions</h5>
                                    <div style={{ background: 'var(--bg-primary)', padding: '10px', borderRadius: '4px' }}>
                                        {alert.recommendedActions}
                                    </div>
                                </div>
                            )}
                            
                            {/* Additional Metadata */}
                            <div style={{ marginBottom: '15px' }}>
                                <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>📊 Additional Details</h5>
                                <div style={{ background: 'var(--bg-primary)', padding: '10px', borderRadius: '4px', fontSize: '12px' }}>
                                    <pre style={{ margin: 0, whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>
                                        {JSON.stringify(alert, null, 2)}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AIIcarusApp = () => {
            // State management
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [userAccount, setUserAccount] = useState(null);
            const [activeWorkflow, setActiveWorkflow] = useState('azure');
            const [activeSubBlade, setActiveSubBlade] = useState('setup');
            const [workspaces, setWorkspaces] = useState([]);
            const [selectedWorkspace, setSelectedWorkspace] = useState(null);
            const [openAIResources, setOpenAIResources] = useState([]);
            const [selectedResource, setSelectedResource] = useState(null);
            const [selectedDeployment, setSelectedDeployment] = useState(null);
            const [deployments, setDeployments] = useState([]);
            const [loadingDeployments, setLoadingDeployments] = useState(false);
            const [kqlQuery, setKqlQuery] = useState('search * | take 10');
            const [queryResults, setQueryResults] = useState(null);
            const [aiPrompt, setAiPrompt] = useState('');
            const [aiData, setAiData] = useState('');
            const [aiResults, setAiResults] = useState(null);
            const [systemPrompt, setSystemPrompt] = useState('You are a cybersecurity analyst specializing in threat detection and incident response.');
            const [userPrompt, setUserPrompt] = useState('Analyze the following security data and identify potential threats, anomalies, or patterns of concern. Provide actionable insights and recommendations.');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isDiscovering, setIsDiscovering] = useState(false);
            const [stats, setStats] = useState({
                totalWorkspaces: 0,
                totalResources: 0,
                tokensUsed: 0,
                chunksProcessed: 0
            });
            
            // M365 Defender state
            const [m365Incidents, setM365Incidents] = useState([]);
            const [m365Alerts, setM365Alerts] = useState([]);
            const [selectedIncident, setSelectedIncident] = useState(null);
            const [showIncidentModal, setShowIncidentModal] = useState(false);
            const [incidentDetails, setIncidentDetails] = useState(null);
            const [incidentAnalysis, setIncidentAnalysis] = useState(null);
            const [aiAnalysisResults, setAiAnalysisResults] = useState(null);
            const [analysisLoading, setAnalysisLoading] = useState(false);
            
            // M365 Defender OpenAI state
            const [m365SelectedResource, setM365SelectedResource] = useState(null);
            const [m365SelectedDeployment, setM365SelectedDeployment] = useState(null);
            const [m365Deployments, setM365Deployments] = useState([]);
            const [m365LoadingDeployments, setM365LoadingDeployments] = useState(false);
            const [showModelSelection, setShowModelSelection] = useState(false);
            const [incidentModalTab, setIncidentModalTab] = useState('Overview');
            const [timelineView, setTimelineView] = useState('narrative'); // Default to narrative view
            const [huntingQuery, setHuntingQuery] = useState('DeviceEvents | take 10');
            const [huntingResults, setHuntingResults] = useState(null);
            const [m365Loading, setM365Loading] = useState(false);
            const [m365Error, setM365Error] = useState(null);
            const [m365ActiveTab, setM365ActiveTab] = useState('incidents');
            
            // Local File Analytics state
            const [localFileStep, setLocalFileStep] = useState(1);
            const [localFile, setLocalFile] = useState(null);
            const [localFileContent, setLocalFileContent] = useState('');
            const [localFileInfo, setLocalFileInfo] = useState(null);
            const [localFileTokenCount, setLocalFileTokenCount] = useState(0);
            const [localFileChunks, setLocalFileChunks] = useState([]);
            const [localFileChunkSize, setLocalFileChunkSize] = useState(30000);
            const [localFileProcessingMode, setLocalFileProcessingMode] = useState('sequential');
            const [localFileResults, setLocalFileResults] = useState([]);
            const [localFileProcessing, setLocalFileProcessing] = useState(false);
            const [localFileProgress, setLocalFileProgress] = useState({ current: 0, total: 0, status: '' });
            const [isDragging, setIsDragging] = useState(false);
            const [isHunting, setIsHunting] = useState(false);
            
            // ELI5 state for Azure Analytics Review blade
            const [showELI5, setShowELI5] = useState(false);
            const [eli5Content, setELI5Content] = useState('');
            const [expandedChunks, setExpandedChunks] = useState({});
            const [localFileProcessingTime, setLocalFileProcessingTime] = useState(0);
            const [m365DataSource, setM365DataSource] = useState('graph'); // Default to Graph API

            // Workflow states
            const [workflowStatus, setWorkflowStatus] = useState({
                azure: {
                    setup: 'pending',
                    query: 'locked',
                    analysis: 'locked',
                    review: 'locked'
                },
                localFile: {
                    select: 'pending',
                    chunking: 'locked',
                    results: 'locked'
                },
                m365: {
                    list: 'pending',
                    detail: 'locked',
                    insights: 'locked'
                }
            });

            // Initialize authentication state
            useEffect(() => {
                const checkAuth = () => {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        setUserAccount(accounts[0]);
                        setIsAuthenticated(true);
                        msalInstance.setActiveAccount(accounts[0]);
                        console.log('User authenticated:', accounts[0].username);
                    }
                };

                // Check immediately
                checkAuth();

                // Also check after a delay to handle redirect scenarios
                setTimeout(checkAuth, 1000);
            }, []);

            // Authentication handlers
            const handleLogin = async () => {
                try {
                    setError(null);
                    setLoading(true);
                    
                    // Check interaction status first (safely check if method exists)
                    if (msalInstance.getInteractionStatus && msalInstance.getInteractionStatus() !== 'none') {
                        setError('Another authentication is in progress. Please wait.');
                        setLoading(false);
                        return;
                    }

                    const response = await msalInstance.loginPopup({
                        scopes: ['openid', 'profile', 'User.Read']
                    });
                    
                    msalInstance.setActiveAccount(response.account);
                    setUserAccount(response.account);
                    setIsAuthenticated(true);
                    setError(null);
                    console.log('Login successful:', response.account.username);
                } catch (error) {
                    console.error('Login error:', error);
                    setError('Failed to authenticate. Please try again.');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                msalInstance.logoutPopup();
                setIsAuthenticated(false);
                setUserAccount(null);
            };

            // Discover workspaces with better error handling
            const discoverWorkspaces = async () => {
                if (isDiscovering) {
                    console.log('Discovery already in progress');
                    return;
                }

                setIsDiscovering(true);
                setLoading(true);
                setError(null);
                
                try {
                    const token = await window.acquireTokenSafe(['https://management.azure.com/.default']);
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/workspaces', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    setWorkspaces(data.workspaces || []);
                    setStats(prev => ({ ...prev, totalWorkspaces: data.workspaces?.length || 0 }));
                    
                    // Auto-select first workspace if available
                    if (data.workspaces?.length > 0 && !selectedWorkspace) {
                        setSelectedWorkspace(data.workspaces[0]);
                        // Enable KQL query step
                        setWorkflowStatus(prev => ({
                            ...prev,
                            azure: { ...prev.azure, query: 'pending' }
                        }));
                    }
                } catch (error) {
                    console.error('Error fetching workspaces:', error);
                    setError(`Failed to fetch workspaces: ${error.message}`);
                } finally {
                    setLoading(false);
                    setIsDiscovering(false);
                }
            };

            // Discover OpenAI resources with better error handling
            const discoverOpenAIResources = async () => {
                if (isDiscovering) {
                    console.log('Discovery already in progress');
                    return;
                }

                setIsDiscovering(true);
                setLoading(true);
                setError(null);
                
                try {
                    const token = await window.acquireTokenSafe(['https://management.azure.com/.default']);
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/openai/resources', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    setOpenAIResources(data.resources || []);
                    setStats(prev => ({ ...prev, totalResources: data.resources?.length || 0 }));
                } catch (error) {
                    console.error('Error fetching OpenAI resources:', error);
                    // Don't set error for OpenAI resources as it's optional
                    console.log('OpenAI resource discovery failed (non-critical)');
                } finally {
                    setLoading(false);
                    setIsDiscovering(false);
                }
            };

            // Fetch deployments for a selected OpenAI resource
            const fetchDeployments = async (resource) => {
                if (!resource) return;
                
                setLoadingDeployments(true);
                setDeployments([]);
                setError(null);
                
                try {
                    const token = await window.acquireTokenSafe();
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/openai-deployments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            resourceId: resource.id,
                            resourceName: resource.name,
                            subscriptionId: resource.subscriptionId
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    setDeployments(data.deployments || []);
                    
                    // Auto-select first deployment if available
                    if (data.deployments?.length > 0) {
                        setSelectedDeployment(data.deployments[0].name);
                    }
                    
                    console.log(`Found ${data.deployments?.length || 0} deployments for ${resource.name}`);
                } catch (error) {
                    console.error('Error fetching deployments:', error);
                    // No fallback - show empty if API fails
                    setDeployments([]);
                    console.log('No deployments available');
                } finally {
                    setLoadingDeployments(false);
                }
            };

            // Fetch deployments for M365 Defender OpenAI resource
            const fetchM365Deployments = async (resource) => {
                if (!resource) return;
                
                setM365LoadingDeployments(true);
                setM365Deployments([]);
                
                try {
                    const token = await window.acquireTokenSafe();
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/openai-deployments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            resourceId: resource.id,
                            resourceName: resource.name,
                            subscriptionId: resource.subscriptionId
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    setM365Deployments(data.deployments || []);
                    
                    // Auto-select deployment: prefer sidebar selection if it exists in the list
                    if (data.deployments?.length > 0) {
                        // Check if the sidebar deployment exists in this resource's deployments
                        const matchingDeployment = data.deployments.find(d => d.name === selectedDeployment);
                        if (matchingDeployment) {
                            setM365SelectedDeployment(matchingDeployment.name);
                        } else if (!m365SelectedDeployment) {
                            // Only auto-select first if no selection exists
                            setM365SelectedDeployment(data.deployments[0].name);
                        }
                    }
                    
                    console.log(`Found ${data.deployments?.length || 0} M365 deployments for ${resource.name}`);
                } catch (error) {
                    console.error('Error fetching M365 deployments:', error);
                    // No fallback - show empty if API fails
                    setM365Deployments([]);
                    console.log('No M365 deployments available');
                } finally {
                    setM365LoadingDeployments(false);
                }
            };

            // Sequential resource discovery
            const discoverAllResources = async () => {
                await discoverWorkspaces();
                // Small delay between calls to avoid conflicts
                await new Promise(resolve => setTimeout(resolve, 500));
                await discoverOpenAIResources();
            };

            // Execute KQL Query
            const executeKQLQuery = async () => {
                if (!selectedWorkspace || !kqlQuery) {
                    setError('Please select a workspace and enter a query');
                    return;
                }

                setLoading(true);
                setError(null);
                
                try {
                    // Use Log Analytics scope for KQL queries
                    const token = await window.acquireTokenSafe(['https://api.loganalytics.io/.default']);
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/kql/execute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            workspaceId: selectedWorkspace.workspaceId,
                            query: kqlQuery
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    setQueryResults(data);
                    
                    // Enable AI analysis step if we have results
                    if (data.rowCount > 0) {
                        setWorkflowStatus(prev => ({
                            ...prev,
                            azure: { ...prev.azure, analysis: 'pending' }
                        }));
                    }
                } catch (error) {
                    console.error('Error executing KQL query:', error);
                    setError(`Failed to execute query: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // Execute AI Analysis with real Azure OpenAI
            const executeAIAnalysis = async () => {
                if (!selectedResource || !selectedDeployment || !queryResults) {
                    setError('Please select an OpenAI resource, deployment, and ensure you have query results');
                    return;
                }

                setIsAnalyzing(true);
                setError(null);
                setAiResults(null);

                try {
                    // Get the selected resource details
                    const resource = typeof selectedResource === 'object' 
                        ? selectedResource 
                        : openAIResources.find(r => r.id === selectedResource);
                    if (!resource) {
                        throw new Error('Selected resource not found');
                    }

                    // Get the API key (you might need to fetch this from the backend)
                    // For now, we'll use the resource endpoint
                    const endpoint = `https://${resource.name}.openai.azure.com`;

                    // Prepare the data for analysis
                    const dataToAnalyze = queryResults.result || queryResults;
                    
                    // Estimate token count and warn if large
                    const dataString = JSON.stringify(dataToAnalyze);
                    const estimatedTokens = Math.ceil(dataString.length / 4);
                    console.log(`[Analysis] Estimated tokens: ${estimatedTokens}`);
                    
                    if (estimatedTokens > 50000) {
                        const proceed = confirm(
                            `This analysis will process approximately ${estimatedTokens.toLocaleString()} tokens.\n\n` +
                            `This is a large amount of data and may take several minutes to process.\n\n` +
                            `The data will be automatically reduced if needed.\n\n` +
                            `Continue?`
                        );
                        if (!proceed) {
                            setIsAnalyzing(false);
                            return;
                        }
                    }

                    // Get access token
                    let accessToken = '';
                    try {
                        const accounts = msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            // Try Cognitive Services scope first, fall back to Management API
                            let response;
                            try {
                                response = await msalInstance.acquireTokenSilent({
                                    scopes: ['https://cognitiveservices.azure.com/.default'],
                                    account: accounts[0]
                                });
                                console.log('Got Cognitive Services token');
                            } catch (cognitiveError) {
                                // Fall back to Management API token which we know works
                                console.log('Cognitive Services token failed, using Management API token as fallback');
                                try {
                                    response = await msalInstance.acquireTokenSilent({
                                        scopes: ['https://management.azure.com/.default'],
                                        account: accounts[0]
                                    });
                                    console.log('Using Management API token for OpenAI access');
                                } catch (mgmtError) {
                                    // If even that fails, try interactive
                                    response = await msalInstance.acquireTokenPopup({
                                        scopes: ['https://management.azure.com/.default'],
                                        account: accounts[0]
                                    });
                                }
                            }
                            accessToken = response.accessToken;
                        }
                    } catch (tokenError) {
                        console.error('Failed to get access token:', tokenError);
                        setError('Authentication failed. Please sign in again.');
                        return;
                    }

                    const API_BASE_URL = 'https://ai-icarus-dev1-func.azurewebsites.net';
                    const response = await fetch(`${API_BASE_URL}/api/analyze-with-ai`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            endpoint: endpoint,
                            deploymentName: selectedDeployment,
                            customSubdomainName: resource.name,
                            systemPrompt: systemPrompt,
                            userPrompt: userPrompt,
                            data: dataToAnalyze,
                            maxTokens: 4000,
                            temperature: 0.7,
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // Check if the analysis actually succeeded
                    if (result.metadata && result.metadata.successfulChunks === 0 && result.metadata.failedChunks > 0) {
                        // Analysis failed - show error message
                        const errorMessage = result.errors && result.errors.length > 0 
                            ? result.errors[0].error 
                            : 'AI analysis failed. Please check your Azure OpenAI deployment configuration.';
                        setError(`AI Analysis Error: ${errorMessage}`);
                        
                        // Set a result with error information
                        setAiResults({
                            ...result,
                            response: `Analysis failed: ${errorMessage}\n\nPlease verify:\n- Azure OpenAI deployment is active\n- API keys are configured\n- Model deployment name is correct\n- You have sufficient quota`,
                            hasError: true
                        });
                    } else if (result.results && result.results.length > 0 && result.results[0].response) {
                        // Extract response from results array (backend returns results array)
                        const combinedResponse = result.results.map(r => r.response).join('\n\n');
                        setAiResults({
                            ...result,
                            response: combinedResponse,
                            hasError: false
                        });
                    } else if (result.response) {
                        // Direct response (old format)
                        setAiResults(result);
                    } else {
                        // Empty response but marked as success
                        setAiResults({
                            ...result,
                            response: 'AI analysis completed but returned no content. This may indicate a configuration issue.',
                            hasError: true
                        });
                    }
                    
                    // Enable the Review blade after successful analysis
                    setWorkflowStatus(prev => ({
                        ...prev,
                        azure: {
                            ...prev.azure,
                            review: 'available'
                        }
                    }));
                } catch (error) {
                    console.error('Error executing AI analysis:', error);
                    setError(`AI Analysis failed: ${error.message}`);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            // Original placeholder executeAIAnalysis function (now replaced above)
            const executeAIAnalysisOld = async () => {
                if (!selectedResource || !selectedDeployment || !aiPrompt) {
                    setError('Please select AI resource, deployment, and enter a prompt');
                    return;
                }

                setLoading(true);
                setError(null);
                
                try {
                    const token = await window.acquireTokenSafe();
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/openai/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            resource: selectedResource,
                            deployment: selectedDeployment,
                            prompt: aiPrompt,
                            data: queryResults || aiData
                        })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    
                    // Transform the response to match the expected format
                    const transformedResults = {
                        summary: {
                            totalChunks: data.metadata?.chunksProcessed || 0,
                            successfulChunks: data.metadata?.successfulChunks || 0,
                            failedChunks: data.metadata?.failedChunks || 0,
                            totalTokensUsed: {
                                input: data.metadata?.totalTokens?.input || 0,
                                output: data.metadata?.totalTokens?.output || 0
                            }
                        },
                        response: data.response,
                        metadata: data.metadata,
                        timestamp: data.timestamp
                    };
                    
                    setAiResults(transformedResults);
                    
                    // Show notification if data was reduced
                    if (data.metadata?.reduced) {
                        console.log('[Analysis] Data was automatically reduced for processing');
                    }
                    
                    // Enable review step
                    setWorkflowStatus(prev => ({
                        ...prev,
                        azure: { ...prev.azure, review: 'pending' }
                    }));
                } catch (error) {
                    console.error('Error executing AI analysis:', error);
                    setError(`Failed to execute analysis: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // Render blade content based on active workflow and sub-blade
            // M365 Defender handlers
            const fetchM365Incidents = async () => {
                setM365Loading(true);
                setM365Error(null);
                
                try {
                    let token, response;
                    
                    if (m365DataSource === 'graph') {
                        // Use Microsoft Graph API directly
                        console.log('Fetching incidents from Microsoft Graph API...');
                        
                        // For Graph API, we need SecurityActions.Read.All scope
                        // Using default scope for now, may need app permissions
                        token = await window.acquireTokenSafe();
                        
                        response = await fetch(`https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender-graph/incidents`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    } else {
                        // Use Sentinel/Log Analytics data
                        console.log('Fetching incidents from Azure Sentinel...');
                        
                        // Check if we have a selected workspace for Sentinel data
                        if (!selectedWorkspace) {
                            setM365Error('Please select a Log Analytics workspace first');
                            setM365Loading(false);
                            return;
                        }
                        
                        // Use management scope for Sentinel queries
                        token = await window.acquireTokenSafe(['https://management.azure.com/.default']);
                        
                        response = await fetch(`https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender-kql/incidents?workspaceId=${selectedWorkspace.workspaceId}&timeRange=30d`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    }
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // If Graph API fails due to licensing, suggest using Sentinel
                        if (m365DataSource === 'graph' && (errorData.message?.includes('403') || errorData.message?.includes('license'))) {
                            setM365Error('Microsoft Graph API requires appropriate licensing. Try switching to Azure Sentinel data source.');
                        } else {
                            throw new Error(errorData.error || errorData.message || 'Failed to fetch incidents');
                        }
                    }
                    
                    const data = await response.json();
                    console.log(`Fetched ${data.incidents?.length || 0} incidents from ${data.source || 'unknown source'}`);
                    setM365Incidents(data.incidents || []);
                } catch (error) {
                    console.error('Error fetching M365 incidents:', error);
                    setM365Error(error.message);
                } finally {
                    setM365Loading(false);
                }
            };
            
            const fetchM365Alerts = async (incidentId = null) => {
                setM365Loading(true);
                setM365Error(null);
                
                try {
                    // Use Microsoft Graph API scope for security data
                    const token = await window.acquireTokenSafe(['https://graph.microsoft.com/.default']);
                    let url = 'https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender/alerts?top=100';
                    if (incidentId) {
                        url += `&incidentId=${incidentId}`;
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to fetch alerts');
                    }
                    
                    const data = await response.json();
                    setM365Alerts(data.alerts || []);
                } catch (error) {
                    console.error('Error fetching M365 alerts:', error);
                    setM365Error(error.message);
                } finally {
                    setM365Loading(false);
                }
            };
            
            // Generate Executive BLUF summary for Azure Analytics
            const generateELI5Summary = (aiResponse) => {
                if (!aiResponse) return "No analysis available yet.";
                
                // Extract key insights from the AI response
                const lines = aiResponse.split('\n');
                const insights = {
                    severity: [],
                    metrics: [],
                    patterns: [],
                    anomalies: [],
                    recommendations: [],
                    technical: []
                };
                
                // Parse the AI response for key information
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const lowerLine = line.toLowerCase();
                    
                    // Extract metrics with context
                    const metricMatch = line.match(/(\d+(?:,\d{3})*(?:\.\d+)?)\s*(gb|mb|kb|tb|bytes|records|rows|events|users|devices|ips|alerts|incidents|queries|operations|requests|failures|errors)/i);
                    if (metricMatch) {
                        const context = lines[Math.max(0, i-1)] + ' ' + line;
                        insights.metrics.push({
                            value: `${metricMatch[1]} ${metricMatch[2]}`,
                            context: context.substring(0, 100)
                        });
                    }
                    
                    // Extract severity and risk indicators
                    if (lowerLine.includes('critical') || lowerLine.includes('severe') || lowerLine.includes('emergency')) {
                        insights.severity.push({ level: 'CRITICAL', description: line.trim() });
                    } else if (lowerLine.includes('high') || lowerLine.includes('elevated') || lowerLine.includes('significant')) {
                        insights.severity.push({ level: 'HIGH', description: line.trim() });
                    } else if (lowerLine.includes('medium') || lowerLine.includes('moderate')) {
                        insights.severity.push({ level: 'MEDIUM', description: line.trim() });
                    }
                    
                    // Extract patterns and anomalies
                    if (lowerLine.includes('pattern') || lowerLine.includes('trend') || lowerLine.includes('spike') || 
                        lowerLine.includes('unusual') || lowerLine.includes('anomaly') || lowerLine.includes('outlier')) {
                        insights.patterns.push(line.trim());
                    }
                    
                    // Extract technical details
                    if (lowerLine.includes('performance') || lowerLine.includes('latency') || lowerLine.includes('throughput') ||
                        lowerLine.includes('cpu') || lowerLine.includes('memory') || lowerLine.includes('disk') ||
                        lowerLine.includes('network') || lowerLine.includes('bandwidth') || lowerLine.includes('iops')) {
                        insights.technical.push(line.trim());
                    }
                    
                    // Extract recommendations
                    if (lowerLine.includes('recommend') || lowerLine.includes('should') || lowerLine.includes('suggest') ||
                        lowerLine.includes('consider') || lowerLine.includes('action') || lowerLine.includes('mitigate')) {
                        insights.recommendations.push(line.trim());
                    }
                }
                
                // Build the Executive BLUF
                let bluf = "📋 **EXECUTIVE SUMMARY (BLUF)**\n\n";
                
                // Primary Assessment
                bluf += "🎯 **BOTTOM LINE:**\n";
                if (insights.severity.filter(s => s.level === 'CRITICAL').length > 0) {
                    bluf += "⛔ **CRITICAL ISSUES DETECTED** - Immediate action required\n";
                    bluf += `${insights.severity.filter(s => s.level === 'CRITICAL').length} critical findings require immediate remediation\n\n`;
                } else if (insights.severity.filter(s => s.level === 'HIGH').length > 0) {
                    bluf += "⚠️ **HIGH PRIORITY ISSUES** - Action needed within 24-48 hours\n";
                    bluf += `${insights.severity.filter(s => s.level === 'HIGH').length} high-priority findings identified\n\n`;
                } else if (insights.severity.length > 0) {
                    bluf += "🔔 **MODERATE ISSUES** - Schedule remediation within business cycle\n";
                    bluf += `${insights.severity.length} findings require attention\n\n`;
                } else {
                    bluf += "✅ **SYSTEM HEALTHY** - No critical issues detected\n";
                    bluf += "All monitored parameters within acceptable thresholds\n\n";
                }
                
                // Key Metrics
                if (insights.metrics.length > 0) {
                    bluf += "📊 **KEY METRICS:**\n";
                    insights.metrics.slice(0, 5).forEach(m => {
                        bluf += `• ${m.value}`;
                        if (m.context.includes('failed') || m.context.includes('error')) {
                            bluf += " ⚠️";
                        } else if (m.context.includes('success') || m.context.includes('completed')) {
                            bluf += " ✅";
                        }
                        bluf += "\n";
                    });
                    bluf += "\n";
                }
                
                // Patterns & Anomalies
                if (insights.patterns.length > 0) {
                    bluf += "🔍 **PATTERNS & ANOMALIES:**\n";
                    insights.patterns.slice(0, 3).forEach(p => {
                        const shortPattern = p.substring(0, 120);
                        bluf += `• ${shortPattern}${p.length > 120 ? '...' : ''}\n`;
                    });
                    bluf += "\n";
                }
                
                // Technical Impact
                if (insights.technical.length > 0) {
                    bluf += "⚙️ **TECHNICAL IMPACT:**\n";
                    insights.technical.slice(0, 3).forEach(t => {
                        const shortTech = t.substring(0, 100);
                        bluf += `• ${shortTech}${t.length > 100 ? '...' : ''}\n`;
                    });
                    bluf += "\n";
                }
                
                // Actionable Recommendations
                bluf += "🎬 **RECOMMENDED ACTIONS:**\n";
                if (insights.recommendations.length > 0) {
                    // Prioritize recommendations
                    const prioritized = insights.recommendations
                        .filter(r => r.toLowerCase().includes('immediate') || r.toLowerCase().includes('critical'))
                        .concat(insights.recommendations.filter(r => !r.toLowerCase().includes('immediate') && !r.toLowerCase().includes('critical')));
                    
                    prioritized.slice(0, 4).forEach((r, idx) => {
                        const shortRec = r.substring(0, 100);
                        bluf += `${idx + 1}. ${shortRec}${r.length > 100 ? '...' : ''}\n`;
                    });
                } else {
                    bluf += "1. Continue standard monitoring protocols\n";
                    bluf += "2. Review metrics during next maintenance window\n";
                    bluf += "3. Document current baseline for future comparison\n";
                }
                bluf += "\n";
                
                // Risk Assessment
                bluf += "⚖️ **RISK ASSESSMENT:**\n";
                const criticalCount = insights.severity.filter(s => s.level === 'CRITICAL').length;
                const highCount = insights.severity.filter(s => s.level === 'HIGH').length;
                const mediumCount = insights.severity.filter(s => s.level === 'MEDIUM').length;
                
                if (criticalCount > 0) {
                    bluf += `• **Business Risk**: HIGH - ${criticalCount} critical issues may impact operations\n`;
                    bluf += `• **Technical Risk**: SEVERE - Immediate remediation required\n`;
                    bluf += `• **Compliance Risk**: Potential SLA/regulatory violations\n`;
                } else if (highCount > 0) {
                    bluf += `• **Business Risk**: MODERATE - ${highCount} issues require prompt attention\n`;
                    bluf += `• **Technical Risk**: ELEVATED - Schedule remediation within 48 hours\n`;
                    bluf += `• **Compliance Risk**: Monitor for SLA impact\n`;
                } else if (mediumCount > 0) {
                    bluf += `• **Business Risk**: LOW - ${mediumCount} issues identified for optimization\n`;
                    bluf += `• **Technical Risk**: MANAGEABLE - Address in next maintenance cycle\n`;
                    bluf += `• **Compliance Risk**: Minimal\n`;
                } else {
                    bluf += `• **Business Risk**: MINIMAL - Systems operating normally\n`;
                    bluf += `• **Technical Risk**: LOW - No immediate concerns\n`;
                    bluf += `• **Compliance Risk**: None identified\n`;
                }
                
                return bluf;
            };
            
            // Local File Analytics Functions
            
            // Simple token counting (approx 4 chars per token)
            const countTokens = (text) => {
                if (!text) return 0;
                // More accurate estimation: ~4 characters per token for English text
                // This matches the C# implementation's approach
                return Math.ceil(text.length / 4);
            };
            
            // Calculate optimal chunk size based on model and prompts
            const calculateOptimalChunkSize = (deployment) => {
                if (!deployment) return 30000;
                
                const modelName = deployment.toLowerCase();
                let maxTokens = 128000; // Default for GPT-4
                
                // Model-specific token limits
                if (modelName.includes('gpt-5')) {
                    maxTokens = 400000;
                } else if (modelName.includes('gpt-4o')) {
                    maxTokens = 128000;
                } else if (modelName.includes('o1-preview')) {
                    maxTokens = 200000;
                } else if (modelName.includes('o1-mini')) {
                    maxTokens = 128000;
                } else if (modelName.includes('gpt-35') || modelName.includes('gpt-3.5')) {
                    maxTokens = 16385;
                }
                
                // Calculate overhead
                const systemTokens = countTokens(systemPrompt);
                const userTokens = countTokens(userPrompt);
                const outputReserved = 4096; // Space for AI response
                const messageOverhead = 100; // JSON structure overhead
                
                // Special handling for reasoning models
                const isReasoningModel = modelName.includes('o1-preview') || modelName.includes('o1-mini');
                const reasoningOverhead = isReasoningModel ? Math.ceil(maxTokens * 0.1) : 0;
                
                const totalOverhead = systemTokens + userTokens + outputReserved + messageOverhead + reasoningOverhead;
                const optimalChunkSize = Math.max(1000, maxTokens - totalOverhead);
                const safeChunkSize = Math.floor(optimalChunkSize * 0.85); // 15% safety margin
                
                return safeChunkSize;
            };
            
            // Handle file drop
            const handleFileDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            };
            
            // Handle file selection
            const handleFileSelect = (file) => {
                if (!file) return;
                
                setLocalFile(file);
                setLocalFileInfo({
                    name: file.name,
                    size: file.size,
                    type: file.type || 'application/octet-stream',
                    lastModified: new Date(file.lastModified).toLocaleString()
                });
                
                // Determine if file is likely text or binary
                const textTypes = [
                    'text/', 'application/json', 'application/xml', 'application/javascript',
                    'application/typescript', 'application/x-yaml', 'application/x-sh',
                    'application/sql', 'application/x-python', 'application/x-ruby'
                ];
                
                const isTextFile = textTypes.some(type => file.type.startsWith(type)) ||
                                  file.name.match(/\.(txt|csv|json|xml|log|md|js|ts|jsx|tsx|py|rb|java|c|cpp|h|hpp|cs|php|html|css|scss|sass|yaml|yml|ini|cfg|conf|sh|bash|zsh|fish|ps1|psm1|psd1|sql|r|m|swift|go|rs|kt|scala|clj|ex|exs|vim|lua|pl|tcl|awk|sed)$/i);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    let content = e.target.result;
                    
                    // For binary files, try to extract readable text
                    if (!isTextFile && typeof content === 'string') {
                        // Remove non-printable characters and extract readable text
                        content = content.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g, ' ');
                    }
                    
                    setLocalFileContent(content);
                    const tokens = countTokens(content);
                    setLocalFileTokenCount(tokens);
                    
                    // Auto-calculate optimal chunk size if deployment is selected
                    if (selectedDeployment) {
                        const optimalSize = calculateOptimalChunkSize(selectedDeployment);
                        setLocalFileChunkSize(Math.min(optimalSize, tokens));
                    }
                };
                
                // Read as text for text files, or attempt text extraction for binary
                reader.readAsText(file, 'UTF-8');
            };
            
            // Create chunks from file content
            const createFileChunks = () => {
                if (!localFileContent) return [];
                
                const chunks = [];
                const chunkSize = localFileChunkSize;
                const totalTokens = localFileTokenCount;
                
                // Convert token size to character size (approx 4 chars per token)
                const charsPerChunk = chunkSize * 4;
                
                for (let i = 0; i < localFileContent.length; i += charsPerChunk) {
                    const chunkText = localFileContent.substring(i, i + charsPerChunk);
                    chunks.push({
                        index: chunks.length + 1,
                        text: chunkText,
                        tokens: countTokens(chunkText),
                        startChar: i,
                        endChar: Math.min(i + charsPerChunk, localFileContent.length)
                    });
                }
                
                return chunks;
            };
            
            // Process file with Azure OpenAI
            const startLocalFileAnalysis = async () => {
                // If no resource is selected but deployment is selected, use a default resource
                const resource = selectedResource || {
                    id: '/subscriptions/default/resourceGroups/default/providers/Microsoft.CognitiveServices/accounts/defaultOpenAI',
                    name: 'defaultOpenAI',
                    location: 'eastus'
                };
                
                if (!selectedDeployment || !localFileContent) {
                    setError('Please select a deployment and upload a file');
                    return;
                }
                
                setLocalFileProcessing(true);
                setLocalFileResults([]);
                const startTime = Date.now();
                const chunks = createFileChunks();
                setLocalFileChunks(chunks);
                
                setLocalFileProgress({
                    current: 0,
                    total: chunks.length,
                    status: 'Starting analysis...'
                });
                
                const results = [];
                
                try {
                    const token = await window.msalInstance.acquireTokenSilent({
                        scopes: ["https://management.azure.com/.default"],
                        account: userAccount
                    });
                    
                    // Process chunks based on selected mode
                    if (localFileProcessingMode === 'sequential') {
                        // Sequential processing
                        for (let i = 0; i < chunks.length; i++) {
                            const chunk = chunks[i];
                            setLocalFileProgress({
                                current: i + 1,
                                total: chunks.length,
                                status: `Processing chunk ${i + 1} of ${chunks.length}...`
                            });
                            
                            try {
                                const result = await processChunkWithAI(chunk, token.accessToken, resource);
                                results.push(result);
                                setLocalFileResults([...results]);
                            } catch (error) {
                                console.error(`Error processing chunk ${i + 1}:`, error);
                                results.push({
                                    chunkIndex: chunk.index,
                                    error: error.message || 'Failed to process chunk'
                                });
                            }
                        }
                    } else {
                        // Parallel processing with controlled concurrency
                        const maxConcurrent = 3;
                        for (let i = 0; i < chunks.length; i += maxConcurrent) {
                            const batch = chunks.slice(i, i + maxConcurrent);
                            setLocalFileProgress({
                                current: i,
                                total: chunks.length,
                                status: `Processing chunks ${i + 1} to ${Math.min(i + maxConcurrent, chunks.length)} of ${chunks.length}...`
                            });
                            
                            const batchPromises = batch.map(chunk => 
                                processChunkWithAI(chunk, token.accessToken, resource).catch(error => ({
                                    chunkIndex: chunk.index,
                                    error: error.message || 'Failed to process chunk'
                                }))
                            );
                            
                            const batchResults = await Promise.all(batchPromises);
                            results.push(...batchResults);
                            setLocalFileResults([...results]);
                        }
                    }
                    
                    setLocalFileProgress({
                        current: chunks.length,
                        total: chunks.length,
                        status: 'Analysis complete!'
                    });
                    
                    // Calculate and set processing time
                    const endTime = Date.now();
                    setLocalFileProcessingTime(endTime - startTime);
                } catch (error) {
                    console.error('Error during file analysis:', error);
                    setError(`Analysis failed: ${error.message}`);
                } finally {
                    setLocalFileProcessing(false);
                }
            };
            
            // Process a single chunk with Azure OpenAI
            const processChunkWithAI = async (chunk, accessToken, resource = selectedResource) => {
                // Use direct Function App URL to avoid Static Web App routing issues
                const functionUrl = `https://ai-icarus-dev1-func.azurewebsites.net/api/analyze-with-ai`;
                
                // Extract custom subdomain from resource endpoint if available
                let customSubdomainName = null;
                if (resource && resource.endpoint) {
                    // Extract subdomain from endpoint like https://xxx.openai.azure.com
                    const match = resource.endpoint.match(/https?:\/\/([^\.]+)\.openai\.azure\.(com|us)/);
                    if (match) {
                        customSubdomainName = match[1];
                        console.log(`Extracted subdomain: ${customSubdomainName} from ${resource.endpoint}`);
                    }
                }
                
                // Build request body matching what the function expects
                const requestBody = {
                    data: chunk.text,
                    systemPrompt: systemPrompt || 'You are a helpful assistant analyzing log files.',
                    userPrompt: userPrompt || 'Please analyze the following data and provide insights:',
                    deploymentName: selectedDeployment,
                    maxTokens: 4096,
                    temperature: 0.7
                };
                
                // Only add customSubdomainName if we have it, otherwise let the function use env variables
                if (customSubdomainName) {
                    requestBody.customSubdomainName = customSubdomainName;
                }
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const result = await response.json();
                
                // Debug: Log the full API response
                console.log('Full API Response:', result);
                
                // Extract the AI response from the expected structure
                let aiResponse = '';
                if (result.results && result.results.length > 0) {
                    // Function returns results array with responses
                    aiResponse = result.results.map(r => r.response || r.content || '').join('\n');
                } else if (result.response) {
                    // Direct response field
                    aiResponse = result.response;
                } else if (result.choices && result.choices.length > 0) {
                    // OpenAI API format
                    aiResponse = result.choices[0].message?.content || '';
                }
                
                // Extract token usage information
                let tokenUsage = {};
                
                // Check for summary.totalTokensUsed first (from analyze-with-ai function)
                if (result.summary && result.summary.totalTokensUsed) {
                    console.log('Found tokens in summary.totalTokensUsed:', result.summary.totalTokensUsed);
                    tokenUsage = {
                        input: result.summary.totalTokensUsed.input || 0,
                        output: result.summary.totalTokensUsed.output || 0,
                        total: (result.summary.totalTokensUsed.input || 0) + (result.summary.totalTokensUsed.output || 0)
                    };
                } else if (result.tokensUsed) {
                    console.log('Found tokens in tokensUsed:', result.tokensUsed);
                    tokenUsage = {
                        input: result.tokensUsed.input || 0,
                        output: result.tokensUsed.output || 0,
                        total: (result.tokensUsed.input || 0) + (result.tokensUsed.output || 0)
                    };
                } else if (result.usage) {
                    console.log('Found tokens in usage:', result.usage);
                    tokenUsage = {
                        input: result.usage.prompt_tokens || 0,
                        output: result.usage.completion_tokens || 0,
                        total: result.usage.total_tokens || ((result.usage.prompt_tokens || 0) + (result.usage.completion_tokens || 0))
                    };
                } else {
                    console.log('No token usage found in response');
                }
                
                console.log('Extracted token usage:', tokenUsage);
                
                return {
                    chunkIndex: chunk.index,
                    tokens: chunk.tokens,
                    response: aiResponse,
                    tokensUsed: tokenUsage,
                    processingTime: result.processingTime || 0
                };
            };
            
            // Toggle chunk expansion in results view
            const toggleChunkExpansion = (index) => {
                setExpandedChunks(prev => ({
                    ...prev,
                    [index]: !prev[index]
                }));
            };
            
            // Format processing time for display
            const formatProcessingTime = (ms) => {
                if (!ms) return '0s';
                if (ms < 1000) return `${ms}ms`;
                if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
                return `${Math.floor(ms / 60000)}m ${((ms % 60000) / 1000).toFixed(0)}s`;
            };
            
            // Export results in different formats
            const exportLocalFileResults = (format) => {
                if (!localFileResults || localFileResults.length === 0) return;
                
                let content = '';
                let filename = `${localFile?.name || 'analysis'}_results.${format}`;
                let mimeType = 'text/plain';
                
                switch (format) {
                    case 'json':
                        content = JSON.stringify({
                            file: localFileInfo,
                            chunks: localFileChunks.map((chunk, idx) => ({
                                ...chunk,
                                analysis: localFileResults[idx]
                            })),
                            metadata: {
                                totalChunks: localFileChunks.length,
                                totalTokens: localFileTokenCount,
                                chunkSize: localFileChunkSize,
                                processingMode: localFileProcessingMode,
                                timestamp: new Date().toISOString()
                            }
                        }, null, 2);
                        mimeType = 'application/json';
                        break;
                        
                    case 'txt':
                        content = `File Analysis Results\n`;
                        content += `=====================\n\n`;
                        content += `File: ${localFileInfo?.name}\n`;
                        content += `Size: ${(localFileInfo?.size / 1024).toFixed(2)} KB\n`;
                        content += `Total Tokens: ${localFileTokenCount}\n`;
                        content += `Chunks: ${localFileChunks.length}\n`;
                        content += `Chunk Size: ${localFileChunkSize} tokens\n\n`;
                        
                        localFileResults.forEach((result, idx) => {
                            content += `\n--- Chunk ${result.chunkIndex} ---\n`;
                            content += `Tokens: ${localFileChunks[idx]?.tokens || 'N/A'}\n`;
                            content += `Analysis:\n${result.response || result.error || 'No analysis available'}\n`;
                            content += `\n`;
                        });
                        break;
                        
                    case 'csv':
                        content = 'Chunk,Tokens,Analysis\n';
                        localFileResults.forEach((result, idx) => {
                            const analysis = (result.response || result.error || 'No analysis').replace(/"/g, '""');
                            content += `${result.chunkIndex},${localFileChunks[idx]?.tokens || 0},"${analysis}"\n`;
                        });
                        mimeType = 'text/csv';
                        break;
                }
                
                // Create and download file
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const fetchIncidentDetails = async (incident) => {
                console.log('fetchIncidentDetails called with incident:', incident);
                console.log('Data source:', m365DataSource);
                console.log('Selected workspace:', selectedWorkspace);
                
                if (!incident) {
                    console.error('Missing incident');
                    return;
                }
                
                // Check if we need a workspace (only for Sentinel data source)
                if (m365DataSource === 'sentinel' && !selectedWorkspace) {
                    console.error('Missing workspace for Sentinel data source');
                    setIncidentDetails({ error: 'Please select a Log Analytics workspace to view incident details from Sentinel.' });
                    return;
                }
                
                setAnalysisLoading(true);
                setIncidentDetails(null);
                setIncidentAnalysis(null);
                setAiAnalysisResults(null);
                
                try {
                    console.log('Acquiring token...');
                    const token = await window.acquireTokenSafe();
                    
                    let response;
                    
                    if (m365DataSource === 'graph') {
                        // Use Graph API for incident details
                        console.log('Fetching incident details from Microsoft Graph API...');
                        
                        const requestBody = {
                            incidentId: incident.id || incident.incidentNumber
                        };
                        
                        console.log('Sending request to m365-defender-graph with body:', requestBody);
                        
                        response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender-graph/incident-details', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                    } else {
                        // Use Sentinel/Log Analytics for incident details
                        console.log('Fetching incident details from Azure Sentinel...');
                        
                        const requestBody = {
                            workspaceId: selectedWorkspace.workspaceId,
                            incident: {
                                incidentNumber: incident.incidentNumber,
                                title: incident.title,
                                description: incident.description,
                                severity: incident.severity,
                                status: incident.status,
                                classification: incident.classification,
                                owner: incident.owner,
                                createdTime: incident.createdTime,
                                lastActivityTime: incident.lastActivityTime,
                                firstActivityTime: incident.firstActivityTime,
                                alertIds: incident.alertIds,
                                alertIdsArray: incident.alertIdsArray, // Pass the pre-parsed array if available
                                alerts: incident.alerts,
                                users: incident.users,
                                devices: incident.devices
                            },
                            includeAlerts: true,
                            includeEntities: true,
                            includeTimeline: true
                        };
                        
                        console.log('Sending request to m365-defender-analysis with body:', requestBody);
                        
                        response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender-analysis/full-analysis', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                    }
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            errorData = { message: errorText };
                        }
                        throw new Error(errorData.error || errorData.message || 'Failed to fetch incident details');
                    }
                    
                    const details = await response.json();
                    console.log('Received incident details:', details);
                    setIncidentDetails(details);
                    // Reset AI analysis when switching incidents
                    setAiAnalysisResults(null);
                    
                    // If we have selected OpenAI resource and deployment, get AI analysis
                    if (selectedResource && selectedDeployment && details.aiContext) {
                        try {
                            console.log('Fetching AI analysis...');
                            const aiResponse = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/analyze-with-ai', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    resourceId: selectedResource.id,
                                    deploymentName: selectedDeployment.name,
                                    systemPrompt: `You are a senior security analyst providing comprehensive incident analysis. 
Focus on:
1. Attack timeline and progression
2. Threat actor tactics and techniques (MITRE ATT&CK)
3. Impact assessment
4. Recommended containment and remediation actions
5. Prevention measures for similar attacks

Format your response with clear sections and actionable insights.`,
                                    userPrompt: `Analyze this security incident:

INCIDENT: ${incident.title} (#${incident.incidentNumber})
Severity: ${incident.severity}
Status: ${incident.status}
Classification: ${incident.classification || 'Under Investigation'}

TIMELINE: ${details.timeline ? details.timeline.map(e => `${e.timestamp}: ${e.title}`).join('\n') : 'No timeline available'}

ALERTS (${details.alerts?.length || 0}):
${details.alerts ? details.alerts.slice(0, 5).map(a => `- ${a.name} (${a.severity}): ${a.description}`).join('\n') : 'No alerts available'}

AFFECTED ENTITIES:
- Users: ${details.statistics?.uniqueUsers || 0}
- Devices: ${details.statistics?.uniqueDevices || 0}
- IPs: ${details.statistics?.uniqueIPs || 0}
- Files: ${details.statistics?.uniqueFiles || 0}

Provide a comprehensive analysis with actionable recommendations.`,
                                    data: JSON.stringify(details.aiContext),
                                    chunkingStrategy: {
                                        method: 'intelligent',
                                        optimalChunkSize: 8000,
                                        overlap: 200
                                    }
                                })
                            });
                            
                            if (aiResponse.ok) {
                                const aiData = await aiResponse.json();
                                setIncidentAnalysis(aiData.results?.[0] || aiData);
                            }
                        } catch (aiError) {
                            console.error('AI analysis failed:', aiError);
                            // Continue without AI analysis
                        }
                    }
                } catch (error) {
                    console.error('Error fetching incident details:', error);
                    setM365Error(error.message);
                    // Also set a flag to show error in modal
                    setIncidentDetails({ error: error.message });
                } finally {
                    setAnalysisLoading(false);
                }
            };
            
            const executeHuntingQuery = async () => {
                if (!huntingQuery.trim()) return;
                
                setM365Loading(true);
                setM365Error(null);
                setHuntingResults(null);
                
                try {
                    // Use Microsoft Graph API scope for security data
                    const token = await window.acquireTokenSafe(['https://graph.microsoft.com/.default']);
                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender-hunting', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: huntingQuery,
                            timespan: 'P1D' // Past 1 day
                        })
                    });
                    
                    // Check if response is ok before trying to parse JSON
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        // Try to parse as JSON, but if it fails, use the text
                        let errorMessage = 'Failed to execute hunting query';
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error || errorData.message || errorMessage;
                            
                            // Check if it's a licensing issue and provide better message
                            if (errorData.note && errorData.note.includes('E5')) {
                                errorMessage = 'Advanced hunting requires Microsoft 365 E5 license. ' + (errorData.message || '');
                            }
                        } catch {
                            // If not JSON, use the raw text if available
                            if (responseText) {
                                errorMessage = responseText;
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    
                    // Parse successful response
                    if (responseText) {
                        try {
                            const data = JSON.parse(responseText);
                            setHuntingResults(data);
                        } catch (parseError) {
                            console.error('Failed to parse response as JSON:', responseText);
                            throw new Error('Invalid response format from server');
                        }
                    } else {
                        throw new Error('Empty response from server');
                    }
                } catch (error) {
                    console.error('Error executing hunting query:', error);
                    setM365Error(error.message);
                } finally {
                    setM365Loading(false);
                }
            };

            const renderBladeContent = () => {
                if (!isAuthenticated) {
                    return (
                        <div className="blade-content">
                            <div className="section">
                                <h2>Welcome to AI Icarus</h2>
                                <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>
                                    Please sign in with your Azure account to continue.
                                </p>
                                <button className="btn btn-primary" onClick={handleLogin} disabled={loading}>
                                    {loading ? 'Signing in...' : 'Sign in with Azure'}
                                </button>
                            </div>
                        </div>
                    );
                }

                // Local File Analytics Workflow
                if (activeWorkflow === 'localFile') {
                    return (
                        <div className="blade-content">
                            <div className="blade-header">
                                <div className="blade-icon">📄</div>
                                <div className="blade-title-section">
                                    <h2>Local File Analytics</h2>
                                    <div className="blade-description">Upload and analyze local files with AI</div>
                                </div>
                            </div>

                            <div className="workflow-tabs" style={{ 
                                display: 'flex', 
                                gap: '10px', 
                                marginBottom: '20px',
                                borderBottom: '1px solid var(--border-primary)',
                                paddingBottom: '10px'
                            }}>
                                <button 
                                    className={`tab-btn ${localFileStep === 1 ? 'active' : ''}`}
                                    onClick={() => setLocalFileStep(1)}
                                    style={{
                                        padding: '8px 16px',
                                        background: localFileStep === 1 ? 'var(--azure-blue)' : 'transparent',
                                        color: localFileStep === 1 ? 'white' : 'var(--text-secondary)',
                                        border: '1px solid var(--border-primary)',
                                        borderRadius: '4px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    1. File Upload
                                </button>
                                <button 
                                    className={`tab-btn ${localFileStep === 2 ? 'active' : ''}`}
                                    onClick={() => setLocalFileStep(2)}
                                    disabled={!localFileContent}
                                    style={{
                                        padding: '8px 16px',
                                        background: localFileStep === 2 ? 'var(--azure-blue)' : 'transparent',
                                        color: localFileStep === 2 ? 'white' : 'var(--text-secondary)',
                                        border: '1px solid var(--border-primary)',
                                        borderRadius: '4px',
                                        cursor: localFileContent ? 'pointer' : 'not-allowed',
                                        opacity: localFileContent ? 1 : 0.5
                                    }}
                                >
                                    2. Chunking
                                </button>
                                <button 
                                    className={`tab-btn ${localFileStep === 3 ? 'active' : ''}`}
                                    onClick={() => setLocalFileStep(3)}
                                    disabled={!localFileResults || localFileResults.length === 0}
                                    style={{
                                        padding: '8px 16px',
                                        background: localFileStep === 3 ? 'var(--azure-blue)' : 'transparent',
                                        color: localFileStep === 3 ? 'white' : 'var(--text-secondary)',
                                        border: '1px solid var(--border-primary)',
                                        borderRadius: '4px',
                                        cursor: localFileResults?.length > 0 ? 'pointer' : 'not-allowed',
                                        opacity: localFileResults?.length > 0 ? 1 : 0.5
                                    }}
                                >
                                    3. Results
                                </button>
                            </div>

                            {/* File Upload Step */}
                            {localFileStep === 1 && (
                                <div className="section">
                                    <h3 className="section-title">📁 Select File for Analysis</h3>
                                    
                                    {/* Drag and Drop Zone */}
                                    <div 
                                        onDrop={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            console.log('File dropped');
                                            setIsDragging(false);
                                            const files = e.dataTransfer.files;
                                            if (files && files.length > 0) {
                                                console.log('Processing dropped file:', files[0].name);
                                                handleFileSelect(files[0]);
                                            }
                                        }}
                                        onDragOver={(e) => { 
                                            e.preventDefault();
                                            e.stopPropagation();
                                        }}
                                        onDragEnter={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            console.log('Drag enter');
                                            setIsDragging(true);
                                        }}
                                        onDragLeave={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            console.log('Drag leave');
                                            setIsDragging(false);
                                        }}
                                        style={{
                                            border: `3px dashed ${isDragging ? 'var(--azure-blue)' : 'var(--border-primary)'}`,
                                            borderRadius: '8px',
                                            padding: '40px',
                                            textAlign: 'center',
                                            background: isDragging ? 'rgba(0, 120, 212, 0.1)' : 'transparent',
                                            transition: 'all 0.3s ease',
                                            marginBottom: '20px',
                                            position: 'relative'
                                        }}
                                    >
                                        <div style={{ fontSize: '48px', marginBottom: '10px' }}>📤</div>
                                        <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '10px' }}>
                                            Drag & Drop your file here
                                        </div>
                                        <div style={{ color: 'var(--text-secondary)', marginBottom: '20px' }}>
                                            — OR —
                                        </div>
                                        
                                        {/* Single, simple, visible file input */}
                                        <div style={{ 
                                            margin: '0 auto',
                                            maxWidth: '400px',
                                            padding: '20px',
                                            background: 'white',
                                            borderRadius: '8px',
                                            border: '2px solid var(--azure-blue)'
                                        }}>
                                            <div style={{ 
                                                fontSize: '16px', 
                                                fontWeight: 'bold', 
                                                marginBottom: '10px',
                                                color: 'var(--azure-blue)'
                                            }}>
                                                📁 Choose File to Upload
                                            </div>
                                            <input 
                                                type="file"
                                                accept="*"
                                                onChange={(e) => {
                                                    console.log('File input changed');
                                                    if (e.target.files && e.target.files.length > 0) {
                                                        const file = e.target.files[0];
                                                        console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);
                                                        handleFileSelect(file);
                                                    } else {
                                                        console.log('No file selected');
                                                    }
                                                }}
                                                style={{
                                                    display: 'block',
                                                    width: '100%',
                                                    padding: '10px',
                                                    fontSize: '16px',
                                                    border: '1px solid var(--border-primary)',
                                                    borderRadius: '4px',
                                                    backgroundColor: '#f5f5f5',
                                                    cursor: 'pointer'
                                                }}
                                            />
                                            <div style={{ 
                                                marginTop: '10px', 
                                                fontSize: '12px', 
                                                color: 'var(--text-secondary)' 
                                            }}>
                                                Supports all file types • Maximum 50MB
                                            </div>
                                        </div>
                                        
                                        {isDragging && (
                                            <div style={{
                                                position: 'absolute',
                                                top: 0,
                                                left: 0,
                                                right: 0,
                                                bottom: 0,
                                                background: 'rgba(0, 120, 212, 0.2)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                borderRadius: '8px',
                                                pointerEvents: 'none'
                                            }}>
                                                <div style={{
                                                    fontSize: '24px',
                                                    fontWeight: 'bold',
                                                    color: 'var(--azure-blue)'
                                                }}>
                                                    Drop file here!
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Alternative: Direct Text Input */}
                                    {!localFileInfo && (
                                        <div style={{
                                            marginTop: '20px',
                                            padding: '20px',
                                            background: 'var(--bg-secondary)',
                                            borderRadius: '8px',
                                            border: '2px solid var(--azure-blue)'
                                        }}>
                                            <div style={{ fontSize: '16px', fontWeight: 'bold', marginBottom: '10px', color: 'var(--azure-blue)' }}>
                                                📝 Alternative: Paste Text Directly
                                            </div>
                                            <div style={{ fontSize: '12px', marginBottom: '10px', color: 'var(--text-secondary)' }}>
                                                If the file dialog doesn't appear, paste your log/text content here:
                                            </div>
                                            <textarea
                                                placeholder="Paste your log file content here (e.g., Convert-ToAuxiliary_20250904_134142.log content)..."
                                                style={{
                                                    width: '100%',
                                                    minHeight: '200px',
                                                    padding: '10px',
                                                    fontSize: '13px',
                                                    fontFamily: 'Consolas, Monaco, monospace',
                                                    border: '1px solid var(--border-primary)',
                                                    borderRadius: '4px',
                                                    backgroundColor: 'white',
                                                    resize: 'vertical'
                                                }}
                                                onPaste={(e) => {
                                                    setTimeout(() => {
                                                        const text = e.target.value;
                                                        if (text && text.trim()) {
                                                            // Create a virtual file from the pasted text
                                                            const blob = new Blob([text], { type: 'text/plain' });
                                                            const virtualFile = new File([blob], 'pasted-log-content.txt', { 
                                                                type: 'text/plain',
                                                                lastModified: Date.now()
                                                            });
                                                            console.log('Text pasted, creating virtual file');
                                                            handleFileSelect(virtualFile);
                                                        }
                                                    }, 100);
                                                }}
                                            />
                                            <button
                                                onClick={() => {
                                                    const textarea = document.querySelector('textarea');
                                                    if (textarea && textarea.value && textarea.value.trim()) {
                                                        const text = textarea.value;
                                                        const blob = new Blob([text], { type: 'text/plain' });
                                                        const virtualFile = new File([blob], 'manual-input.txt', { 
                                                            type: 'text/plain',
                                                            lastModified: Date.now()
                                                        });
                                                        console.log('Processing manually entered text');
                                                        handleFileSelect(virtualFile);
                                                    }
                                                }}
                                                style={{
                                                    marginTop: '10px',
                                                    padding: '8px 20px',
                                                    fontSize: '14px',
                                                    fontWeight: 'bold',
                                                    background: 'var(--azure-blue)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                Process Pasted Text
                                            </button>
                                            <div style={{ marginTop: '10px', fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                Tip: Open your log file in Notepad, select all (Ctrl+A), copy (Ctrl+C), then paste here (Ctrl+V)
                                            </div>
                                        </div>
                                    )}

                                    {/* File Info Display */}
                                    {localFileInfo && (
                                        <div style={{
                                            background: 'var(--bg-secondary)',
                                            padding: '20px',
                                            borderRadius: '8px',
                                            marginBottom: '20px'
                                        }}>
                                            <h4 style={{ marginBottom: '15px' }}>📄 File Information</h4>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '5px' }}>File Name</div>
                                                    <div style={{ fontWeight: 'bold' }}>{localFileInfo.name}</div>
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '5px' }}>File Size</div>
                                                    <div style={{ fontWeight: 'bold' }}>{(localFileInfo.size / 1024).toFixed(2)} KB</div>
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '5px' }}>Estimated Tokens</div>
                                                    <div style={{ fontWeight: 'bold' }}>
                                                        {localFileTokenCount ? localFileTokenCount.toLocaleString() : 'Calculating...'}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '5px' }}>File Type</div>
                                                    <div style={{ fontWeight: 'bold' }}>{localFileInfo.type || 'Unknown'}</div>
                                                </div>
                                            </div>
                                            
                                            {/* Show warning for binary files */}
                                            {localFileInfo && localFileInfo.type && 
                                             !localFileInfo.type.startsWith('text/') && 
                                             !localFileInfo.name.match(/\.(txt|csv|json|xml|log|md|js|ts|jsx|tsx|py|rb|java|c|cpp|h|hpp|cs|php|html|css|scss|sass|yaml|yml|ini|cfg|conf|sh|bash|zsh|fish|ps1|psm1|psd1|sql|r|m|swift|go|rs|kt|scala|clj|ex|exs|vim|lua|pl|tcl|awk|sed)$/i) && (
                                                <div style={{
                                                    marginTop: '15px',
                                                    padding: '10px',
                                                    background: 'var(--warning-light)',
                                                    border: '1px solid var(--warning-orange)',
                                                    borderRadius: '4px',
                                                    fontSize: '12px',
                                                    color: 'var(--warning-orange)'
                                                }}>
                                                    ⚠️ Binary file detected. The system will attempt to extract readable text for analysis.
                                                </div>
                                            )}
                                            
                                            {localFileContent && (
                                                <div style={{ marginTop: '20px' }}>
                                                    <button 
                                                        className="btn btn-primary"
                                                        onClick={() => setLocalFileStep(2)}
                                                    >
                                                        Proceed to Chunking →
                                                    </button>
                                                    <button 
                                                        className="btn btn-secondary"
                                                        onClick={() => {
                                                            setLocalFile(null);
                                                            setLocalFileContent('');
                                                            setLocalFileInfo(null);
                                                            setLocalFileTokenCount(0);
                                                            setLocalFileChunks([]);
                                                            setLocalFileResults([]);
                                                        }}
                                                        style={{ marginLeft: '10px' }}
                                                    >
                                                        Clear File
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Chunking Step */}
                            {localFileStep === 2 && (
                                <div className="section">
                                    <h3 className="section-title">🔧 Configure Chunking</h3>
                                    
                                    {/* OpenAI Deployment Selection */}
                                    <div style={{ marginBottom: '20px' }}>
                                        <label style={{ display: 'block', marginBottom: '10px' }}>Select OpenAI Deployment:</label>
                                        <select 
                                            value={selectedDeployment || ''}
                                            onChange={(e) => {
                                                setSelectedDeployment(e.target.value);
                                                if (e.target.value) {
                                                    const optimalSize = calculateOptimalChunkSize(e.target.value);
                                                    setLocalFileChunkSize(Math.min(optimalSize, localFileTokenCount));
                                                }
                                            }}
                                            className="form-select"
                                            style={{ width: '100%', padding: '10px' }}
                                        >
                                            <option value="">Select a deployment...</option>
                                            {deployments.length > 0 ? (
                                                deployments.map(dep => (
                                                    <option key={dep.name || dep} value={dep.name || dep}>
                                                        {dep.name || dep}
                                                    </option>
                                                ))
                                            ) : (
                                                <>
                                                    <option value="gpt-4o-mini">gpt-4o-mini (128K tokens)</option>
                                                    <option value="gpt-5-mini">gpt-5-mini (400K tokens)</option>
                                                    <option value="gpt-o1-preview">gpt-o1-preview (200K tokens)</option>
                                                    <option value="gpt-o1-mini">gpt-o1-mini (128K tokens)</option>
                                                    <option value="text-embedding-ada-002">text-embedding-ada-002</option>
                                                </>
                                            )}
                                        </select>
                                    </div>

                                    {/* Chunk Size Configuration */}
                                    {selectedDeployment && (
                                        <div style={{
                                            background: 'var(--bg-secondary)',
                                            padding: '20px',
                                            borderRadius: '8px',
                                            marginBottom: '20px'
                                        }}>
                                            <h4 style={{ marginBottom: '15px' }}>Chunk Configuration</h4>
                                            
                                            <div style={{ marginBottom: '20px' }}>
                                                <label style={{ display: 'block', marginBottom: '10px' }}>
                                                    Chunk Size: {localFileChunkSize?.toLocaleString()} tokens
                                                </label>
                                                <input 
                                                    type="range"
                                                    min="1000"
                                                    max={Math.min(calculateOptimalChunkSize(selectedDeployment), localFileTokenCount)}
                                                    value={localFileChunkSize}
                                                    onChange={(e) => setLocalFileChunkSize(parseInt(e.target.value))}
                                                    style={{ width: '100%' }}
                                                />
                                                <div style={{ 
                                                    display: 'flex', 
                                                    justifyContent: 'space-between',
                                                    fontSize: '12px',
                                                    color: 'var(--text-secondary)',
                                                    marginTop: '5px'
                                                }}>
                                                    <span>1,000</span>
                                                    <span>Optimal: {calculateOptimalChunkSize(selectedDeployment)?.toLocaleString()}</span>
                                                    <span>{Math.min(calculateOptimalChunkSize(selectedDeployment), localFileTokenCount).toLocaleString()}</span>
                                                </div>
                                            </div>

                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '5px' }}>
                                                        Estimated Chunks
                                                    </div>
                                                    <div style={{ fontSize: '24px', fontWeight: 'bold', color: 'var(--azure-blue)' }}>
                                                        {Math.ceil((localFileTokenCount || 0) / localFileChunkSize)}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '5px' }}>
                                                        Processing Mode
                                                    </div>
                                                    <select 
                                                        value={localFileProcessingMode}
                                                        onChange={(e) => setLocalFileProcessingMode(e.target.value)}
                                                        style={{ padding: '5px', width: '100%' }}
                                                    >
                                                        <option value="sequential">Sequential (Safe)</option>
                                                        <option value="parallel">Parallel (Fast)</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div style={{ marginTop: '20px' }}>
                                                <label style={{ display: 'block', marginBottom: '10px' }}>Analysis Prompt:</label>
                                                <textarea 
                                                    value={userPrompt}
                                                    onChange={(e) => setUserPrompt(e.target.value)}
                                                    placeholder="Enter your analysis instructions..."
                                                    style={{
                                                        width: '100%',
                                                        minHeight: '100px',
                                                        padding: '10px',
                                                        background: 'var(--bg-primary)',
                                                        border: '1px solid var(--border-primary)',
                                                        borderRadius: '4px',
                                                        color: 'var(--text-primary)',
                                                        resize: 'vertical'
                                                    }}
                                                />
                                            </div>

                                            <div style={{ marginTop: '20px' }}>
                                                <button 
                                                    className="btn btn-primary"
                                                    onClick={startLocalFileAnalysis}
                                                    disabled={!selectedDeployment || localFileProcessing}
                                                >
                                                    {localFileProcessing ? '🔄 Processing...' : '🚀 Start Analysis'}
                                                </button>
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => setLocalFileStep(1)}
                                                    style={{ marginLeft: '10px' }}
                                                    disabled={localFileProcessing}
                                                >
                                                    ← Back to Upload
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* Progress Display */}
                                    {localFileProcessing && (
                                        <div style={{
                                            background: 'var(--bg-secondary)',
                                            padding: '20px',
                                            borderRadius: '8px',
                                            marginTop: '20px'
                                        }}>
                                            <h4 style={{ marginBottom: '15px' }}>Processing Progress</h4>
                                            <div style={{ marginBottom: '10px' }}>
                                                {localFileProgress.status || 'Processing...'}
                                            </div>
                                            <div style={{
                                                background: 'var(--bg-primary)',
                                                height: '30px',
                                                borderRadius: '4px',
                                                overflow: 'hidden',
                                                position: 'relative'
                                            }}>
                                                <div style={{
                                                    background: 'var(--azure-blue)',
                                                    height: '100%',
                                                    width: `${(localFileProgress.current / localFileProgress.total * 100) || 0}%`,
                                                    transition: 'width 0.3s ease',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    color: 'white',
                                                    fontWeight: 'bold'
                                                }}>
                                                    {Math.round((localFileProgress.current / localFileProgress.total * 100) || 0)}%
                                                </div>
                                            </div>
                                            <div style={{ marginTop: '10px', fontSize: '14px', color: 'var(--text-secondary)' }}>
                                                Chunk {localFileProgress.current} of {localFileProgress.total}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Results Step */}
                            {localFileStep === 3 && localFileResults && localFileResults.length > 0 && (
                                <div className="section">
                                    <h3 className="section-title">📊 Analysis Results</h3>
                                    
                                    {/* Summary Stats */}
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                        gap: '15px',
                                        marginBottom: '20px'
                                    }}>
                                        <div className="metric-card">
                                            <div className="metric-label">Total Chunks</div>
                                            <div className="metric-value">{localFileResults.length}</div>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">Total Tokens Used</div>
                                            <div className="metric-value">
                                                {localFileResults.reduce((sum, r) => {
                                                    const tokens = r.tokensUsed;
                                                    if (typeof tokens === 'object' && tokens) {
                                                        return sum + (tokens.total || 0);
                                                    }
                                                    return sum + (tokens || 0);
                                                }, 0).toLocaleString()}
                                            </div>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">Processing Time</div>
                                            <div className="metric-value">{formatProcessingTime(localFileProcessingTime)}</div>
                                        </div>
                                    </div>

                                    {/* Export Buttons */}
                                    <div style={{ marginBottom: '20px' }}>
                                        <button 
                                            className="btn btn-primary"
                                            onClick={() => exportLocalFileResults('json')}
                                        >
                                            📥 Export JSON
                                        </button>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => exportLocalFileResults('txt')}
                                            style={{ marginLeft: '10px' }}
                                        >
                                            📄 Export Text
                                        </button>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => exportLocalFileResults('csv')}
                                            style={{ marginLeft: '10px' }}
                                        >
                                            📊 Export CSV
                                        </button>
                                    </div>

                                    {/* Results Display */}
                                    <div>
                                        <h4 style={{ marginBottom: '15px' }}>Chunk Analysis Results</h4>
                                        {localFileResults.map((result, idx) => (
                                            <div key={idx} style={{
                                                background: 'var(--bg-secondary)',
                                                padding: '15px',
                                                borderRadius: '8px',
                                                marginBottom: '15px'
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    marginBottom: '10px',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => toggleChunkExpansion(idx)}
                                                >
                                                    <h5 style={{ margin: 0 }}>
                                                        Chunk {idx + 1} of {localFileResults.length}
                                                    </h5>
                                                    <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                                        <span style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                                            {result.tokens?.toLocaleString() || 'N/A'} tokens
                                                        </span>
                                                        <span>{expandedChunks[idx] ? '▼' : '▶'}</span>
                                                    </div>
                                                </div>
                                                
                                                {expandedChunks[idx] && (
                                                    <div style={{
                                                        marginTop: '10px',
                                                        padding: '10px',
                                                        background: 'var(--bg-primary)',
                                                        borderRadius: '4px',
                                                        whiteSpace: 'pre-wrap',
                                                        fontFamily: 'monospace',
                                                        fontSize: '14px',
                                                        maxHeight: '400px',
                                                        overflow: 'auto'
                                                    }}>
                                                        {result.response}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>

                                    {/* Back Button */}
                                    <div style={{ marginTop: '20px' }}>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => {
                                                setLocalFileStep(1);
                                                setLocalFile(null);
                                                setLocalFileContent('');
                                                setLocalFileInfo(null);
                                                setLocalFileTokenCount(0);
                                                setLocalFileChunks([]);
                                                setLocalFileResults([]);
                                                setExpandedChunks({});
                                            }}
                                        >
                                            ← Analyze Another File
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }

                if (activeWorkflow === 'azure' && activeSubBlade === 'setup') {
                    return (
                        <div className="blade-content">
                            {error && (
                                <div className="error-message">
                                    <span>❌</span>
                                    <div>
                                        <div style={{ fontWeight: 'bold' }}>Error</div>
                                        <div>{error}</div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="blade-header">
                                <div className="blade-icon">☁️</div>
                                <div className="blade-title-section">
                                    <h2>Azure Setup</h2>
                                    <div className="blade-description">Configure Azure authentication and discover resources</div>
                                </div>
                            </div>

                            <div className="section">
                                <h3 className="section-title">Azure Environment</h3>
                                <div className="success-message">
                                    <span>✅</span>
                                    <div>
                                        <div>Connected to Azure</div>
                                        <div style={{ fontSize: '12px' }}>Logged in as: {userAccount?.username}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="section">
                                <h3 className="section-title">Resource Discovery</h3>
                                
                                <div className="btn-group">
                                    <button 
                                        className="btn btn-primary" 
                                        onClick={discoverAllResources}
                                        disabled={loading || isDiscovering}
                                    >
                                        {isDiscovering ? (
                                            <>
                                                <div className="loading-spinner"></div>
                                                Discovering...
                                            </>
                                        ) : (
                                            '🔍 Discover Resources'
                                        )}
                                    </button>
                                </div>

                                {/* Configuration Summary */}
                                {(selectedWorkspace || selectedResource || selectedDeployment) && (
                                    <div style={{ 
                                        background: 'var(--bg-secondary)', 
                                        padding: '15px', 
                                        borderRadius: '8px',
                                        marginTop: '20px',
                                        marginBottom: '20px',
                                        border: '1px solid var(--border-color)'
                                    }}>
                                        <h4 style={{ marginTop: 0, marginBottom: '10px', color: 'var(--primary-color)' }}>
                                            ✅ Active Configuration
                                        </h4>
                                        <div style={{ fontSize: '12px', lineHeight: '1.6' }}>
                                            {selectedWorkspace && (
                                                <div>
                                                    <strong>Workspace:</strong> {selectedWorkspace.workspaceName}
                                                </div>
                                            )}
                                            {selectedResource && (
                                                <div>
                                                    <strong>OpenAI Resource:</strong> {selectedResource.name}
                                                </div>
                                            )}
                                            {selectedDeployment && (
                                                <div>
                                                    <strong>Deployment:</strong> {selectedDeployment}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                <div className="form-group" style={{ marginTop: '20px' }}>
                                    <div className="form-group">
                                        <label className="form-label">Log Analytics Workspaces</label>
                                        <select 
                                            className="form-select"
                                            value={selectedWorkspace?.workspaceId || ''}
                                            onChange={(e) => {
                                                const workspace = workspaces.find(w => w.workspaceId === e.target.value);
                                                setSelectedWorkspace(workspace);
                                                if (workspace) {
                                                    setWorkflowStatus(prev => ({
                                                        ...prev,
                                                        azure: { ...prev.azure, query: 'pending' }
                                                    }));
                                                }
                                            }}
                                        >
                                            <option value="">-- Select Workspace --</option>
                                            {workspaces.map(workspace => (
                                                <option key={workspace.workspaceId} value={workspace.workspaceId}>
                                                    {workspace.workspaceName} ({workspace.resourceGroup})
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">OpenAI Resources</label>
                                        <select 
                                            className="form-select"
                                            value={selectedResource?.id || ''}
                                            onChange={(e) => {
                                                const resource = openAIResources.find(r => r.id === e.target.value);
                                                setSelectedResource(resource);
                                                setSelectedDeployment(''); // Reset deployment selection
                                                if (resource) {
                                                    fetchDeployments(resource);
                                                }
                                            }}
                                        >
                                            <option value="">-- Select Resource --</option>
                                            {openAIResources.map(resource => (
                                                <option key={resource.id} value={resource.id}>
                                                    {resource.name} ({resource.location})
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Deployment Selection */}
                                    <div className="form-group">
                                        <label className="form-label">Model Deployment</label>
                                        {loadingDeployments ? (
                                            <div style={{ padding: '10px', color: 'var(--text-secondary)' }}>
                                                Loading deployments...
                                            </div>
                                        ) : (
                                            <select 
                                                className="form-select"
                                                value={selectedDeployment || ''}
                                                onChange={(e) => setSelectedDeployment(e.target.value)}
                                                disabled={!selectedResource || deployments.length === 0}
                                            >
                                                <option value="">-- Select Deployment --</option>
                                                {deployments.map(deployment => (
                                                    <option key={deployment.name} value={deployment.name}>
                                                        {deployment.name} ({deployment.model?.name || 'Unknown model'})
                                                    </option>
                                                ))}
                                            </select>
                                        )}
                                        {selectedResource && deployments.length === 0 && !loadingDeployments && (
                                            <div style={{ 
                                                fontSize: '11px', 
                                                color: 'var(--text-secondary)', 
                                                marginTop: '5px' 
                                            }}>
                                                No deployments found for this resource
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (activeWorkflow === 'azure' && activeSubBlade === 'analysis') {
                    return (
                        <div className="blade-content">
                            <div className="blade-header">
                                <div className="blade-icon">🤖</div>
                                <div className="blade-title-section">
                                    <h2>AI Analysis</h2>
                                    <div className="blade-description">Analyze data using Azure OpenAI</div>
                                </div>
                            </div>
                            <div className="section">
                                <h3>Analysis Configuration</h3>
                                
                                {/* OpenAI Resource Selection */}
                                <div className="form-group">
                                    <label>OpenAI Resource</label>
                                    <select 
                                        value={selectedResource?.id || ''}
                                        onChange={(e) => {
                                            const resource = openAIResources.find(r => r.id === e.target.value);
                                            setSelectedResource(resource);
                                            setSelectedDeployment('');
                                            if (resource) {
                                                fetchDeployments(resource);
                                            }
                                        }}
                                        className="form-select"
                                    >
                                        <option value="">Select a resource...</option>
                                        {openAIResources.map(resource => (
                                            <option key={resource.id} value={resource.id}>
                                                {resource.name} | {resource.location}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* Model Deployment Selection */}
                                <div className="form-group">
                                    <label>Model Deployment</label>
                                    {loadingDeployments ? (
                                        <div className="spinner-container">
                                            <div className="spinner"></div>
                                            <span>Loading deployments...</span>
                                        </div>
                                    ) : (
                                        <select 
                                            value={selectedDeployment}
                                            onChange={(e) => setSelectedDeployment(e.target.value)}
                                            className="form-select"
                                            disabled={!selectedResource || deployments.length === 0}
                                        >
                                            <option value="">Select a deployment...</option>
                                            {deployments.map(deployment => (
                                                <option key={deployment.name} value={deployment.name}>
                                                    {deployment.name} ({deployment.model} - {deployment.status})
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                </div>

                                {/* System Prompt */}
                                <div className="form-group">
                                    <label>System Prompt</label>
                                    <textarea
                                        className="form-textarea"
                                        rows="3"
                                        value={systemPrompt}
                                        onChange={(e) => setSystemPrompt(e.target.value)}
                                        placeholder="You are a cybersecurity analyst..."
                                    />
                                </div>

                                {/* User Prompt */}
                                <div className="form-group">
                                    <label>Analysis Instructions</label>
                                    <textarea
                                        className="form-textarea"
                                        rows="4"
                                        value={userPrompt}
                                        onChange={(e) => setUserPrompt(e.target.value)}
                                        placeholder="Analyze the following security data and identify potential threats..."
                                    />
                                </div>

                                {/* Data Preview */}
                                {queryResults && (
                                    <div className="form-group">
                                        <label>Data to Analyze</label>
                                        <div className="data-preview">
                                            <small>{queryResults.rowCount} rows from KQL query</small>
                                        </div>
                                    </div>
                                )}

                                {/* Analyze Button */}
                                <button 
                                    className="btn btn-primary"
                                    onClick={executeAIAnalysis}
                                    disabled={!selectedResource || !selectedDeployment || !queryResults || isAnalyzing}
                                >
                                    {isAnalyzing ? 'Analyzing...' : '🔍 Analyze with AI'}
                                </button>

                                {/* Analysis Results */}
                                {aiResults && (
                                    <div className="query-results" style={{ marginTop: '20px' }}>
                                        <h3>Analysis Results</h3>
                                        <div className="result-summary">
                                            <span className="result-stat">
                                                {aiResults.summary?.successfulChunks}/{aiResults.summary?.totalChunks} chunks processed
                                            </span>
                                            <span className="result-stat">
                                                Tokens: {aiResults.summary?.totalTokensUsed?.input} in / {aiResults.summary?.totalTokensUsed?.output} out
                                            </span>
                                        </div>
                                        
                                        {/* Display the AI response or error */}
                                        {(aiResults.response || aiResults.hasError) && (
                                            <div className="ai-response" style={{ 
                                                marginTop: '20px', 
                                                padding: '15px', 
                                                background: 'var(--bg-secondary)', 
                                                borderRadius: '4px',
                                                border: '1px solid var(--border-color)'
                                            }}>
                                                <h4 style={{ 
                                                    marginBottom: '10px',
                                                    color: aiResults.hasError ? '#ff6b6b' : 'inherit'
                                                }}>
                                                    {aiResults.hasError ? '⚠️ Analysis Issue' : 'AI Analysis'}
                                                </h4>
                                                <pre style={{ 
                                                    whiteSpace: 'pre-wrap', 
                                                    wordWrap: 'break-word',
                                                    fontFamily: 'monospace',
                                                    fontSize: '14px',
                                                    lineHeight: '1.5'
                                                }}>{aiResults.response}</pre>
                                            </div>
                                        )}
                                        
                                        {/* Display metadata if available */}
                                        {aiResults.metadata && (
                                            <div style={{ marginTop: '15px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                                                <div>Model: {aiResults.metadata.modelUsed}</div>
                                                <div>Processing time: {aiResults.metadata.performance?.averageLatency}ms</div>
                                                {aiResults.metadata.costEstimate && (
                                                    <div>Estimated cost: ${typeof aiResults.metadata.costEstimate.totalCost === 'number' ? aiResults.metadata.costEstimate.totalCost.toFixed(4) : 'N/A'}</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                if (activeWorkflow === 'azure' && activeSubBlade === 'review') {
                    return (
                        <div className="blade-content">
                            <div className="blade-header">
                                <div className="blade-icon">📋</div>
                                <div className="blade-title-section">
                                    <h2>Review & Export</h2>
                                    <div className="blade-description">Review analysis results and export data</div>
                                </div>
                            </div>

                            <div className="section">
                                <h3 className="section-title">Analysis Summary</h3>
                                
                                {aiResults ? (
                                    <>
                                        <div className="summary-grid" style={{ 
                                            display: 'grid', 
                                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                            gap: '15px',
                                            marginBottom: '20px'
                                        }}>
                                            <div className="summary-card" style={{
                                                padding: '15px',
                                                background: 'var(--bg-secondary)',
                                                borderRadius: '4px'
                                            }}>
                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Workspace</div>
                                                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                                                    {selectedWorkspace?.workspaceName || 'N/A'}
                                                </div>
                                            </div>
                                            
                                            <div className="summary-card" style={{
                                                padding: '15px',
                                                background: 'var(--bg-secondary)',
                                                borderRadius: '4px'
                                            }}>
                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Query Results</div>
                                                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                                                    {queryResults?.rowCount || 0} rows
                                                </div>
                                            </div>
                                            
                                            <div className="summary-card" style={{
                                                padding: '15px',
                                                background: 'var(--bg-secondary)',
                                                borderRadius: '4px'
                                            }}>
                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>AI Model</div>
                                                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                                                    {aiResults.metadata?.modelUsed || selectedDeployment}
                                                </div>
                                            </div>
                                            
                                            <div className="summary-card" style={{
                                                padding: '15px',
                                                background: 'var(--bg-secondary)',
                                                borderRadius: '4px'
                                            }}>
                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Tokens Used</div>
                                                <div style={{ fontSize: '16px', fontWeight: 'bold' }}>
                                                    {(aiResults.summary?.totalTokensUsed?.input || 0) + (aiResults.summary?.totalTokensUsed?.output || 0)}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
                                            <h3 className="section-title" style={{ margin: 0 }}>AI Analysis Results</h3>
                                            {aiResults.response && !aiResults.hasError && (
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => {
                                                        // Generate ELI5 summary
                                                        const eli5Summary = generateELI5Summary(aiResults.response);
                                                        setShowELI5(true);
                                                        setELI5Content(eli5Summary);
                                                    }}
                                                    style={{
                                                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                        border: 'none',
                                                        color: 'white',
                                                        padding: '8px 16px',
                                                        borderRadius: '4px',
                                                        fontSize: '14px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px'
                                                    }}
                                                >
                                                    <span>📋</span> Executive BLUF
                                                </button>
                                            )}
                                        </div>
                                        
                                        {/* ELI5 Summary Box */}
                                        {showELI5 && eli5Content && (
                                            <div style={{
                                                background: 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)',
                                                border: '2px solid #667eea',
                                                borderRadius: '8px',
                                                padding: '20px',
                                                marginBottom: '20px',
                                                position: 'relative'
                                            }}>
                                                <button
                                                    onClick={() => setShowELI5(false)}
                                                    style={{
                                                        position: 'absolute',
                                                        top: '10px',
                                                        right: '10px',
                                                        background: 'transparent',
                                                        border: 'none',
                                                        color: '#667eea',
                                                        fontSize: '20px',
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    ×
                                                </button>
                                                <div style={{ marginBottom: '15px' }}>
                                                    <h4 style={{ color: '#667eea', marginBottom: '10px', fontSize: '18px' }}>
                                                        📋 Executive Summary (Bottom Line Up Front)
                                                    </h4>
                                                    <div style={{
                                                        fontSize: '16px',
                                                        lineHeight: '1.6',
                                                        color: 'var(--text-primary)'
                                                    }}>
                                                        {eli5Content.split('\n').map((line, idx) => {
                                                            // Handle bold text
                                                            let formattedLine = line;
                                                            if (line.includes('**')) {
                                                                const parts = line.split('**');
                                                                formattedLine = parts.map((part, i) => 
                                                                    i % 2 === 1 ? <strong key={i}>{part}</strong> : part
                                                                );
                                                            }
                                                            
                                                            // Handle different line types
                                                            if (line.startsWith('📋')) {
                                                                return <div key={idx} style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '15px', color: '#667eea' }}>{formattedLine}</div>;
                                                            } else if (line.startsWith('🎯') || line.startsWith('⛔') || line.startsWith('⚠️') || line.startsWith('🔔') || line.startsWith('✅')) {
                                                                return <div key={idx} style={{ fontSize: '16px', marginBottom: '10px', paddingLeft: '20px' }}>{formattedLine}</div>;
                                                            } else if (line.startsWith('📊') || line.startsWith('🔍') || line.startsWith('⚙️') || line.startsWith('🎬') || line.startsWith('⚖️')) {
                                                                return <div key={idx} style={{ fontSize: '16px', fontWeight: 'bold', marginTop: '20px', marginBottom: '10px', color: '#4a5568' }}>{formattedLine}</div>;
                                                            } else if (line.startsWith('•') || line.startsWith('   •')) {
                                                                return <div key={idx} style={{ marginLeft: '20px', marginBottom: '5px' }}>{formattedLine}</div>;
                                                            } else if (line.match(/^\d\./)) {
                                                                return <div key={idx} style={{ marginLeft: '20px', marginBottom: '5px' }}>{formattedLine}</div>;
                                                            } else if (line.trim() === '') {
                                                                return <br key={idx} />;
                                                            } else {
                                                                return <div key={idx} style={{ marginBottom: '8px' }}>{formattedLine}</div>;
                                                            }
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {aiResults.hasError ? (
                                            <div style={{
                                                padding: '20px',
                                                background: '#ffebee',
                                                border: '1px solid #ffcdd2',
                                                borderRadius: '4px',
                                                marginBottom: '20px'
                                            }}>
                                                <div style={{ color: '#c62828', fontWeight: 'bold', marginBottom: '10px' }}>⚠️ Analysis Issue Detected</div>
                                                <pre style={{
                                                    whiteSpace: 'pre-wrap',
                                                    wordWrap: 'break-word',
                                                    fontFamily: 'monospace',
                                                    fontSize: '14px',
                                                    margin: 0,
                                                    color: '#d32f2f'
                                                }}>{aiResults.response || 'No analysis results available'}</pre>
                                            </div>
                                        ) : aiResults.response ? (
                                        <div style={{ 
                                            padding: '15px', 
                                            background: 'var(--bg-secondary)', 
                                            borderRadius: '4px',
                                            marginBottom: '20px'
                                        }}>
                                            <pre style={{ 
                                                whiteSpace: 'pre-wrap', 
                                                wordWrap: 'break-word',
                                                fontFamily: 'monospace',
                                                fontSize: '14px',
                                                lineHeight: '1.5',
                                                margin: 0
                                            }}>{aiResults.response || 'No analysis results available'}</pre>
                                        </div>
                                        ) : (
                                            <div style={{
                                                padding: '40px',
                                                textAlign: 'center',
                                                color: 'var(--text-secondary)'
                                            }}>
                                                No analysis results available. Please run an AI analysis first.
                                            </div>
                                        )}
                                        
                                        {aiResults.response && !aiResults.hasError && (
                                        <div className="btn-group">
                                            <button className="btn btn-primary" onClick={() => {
                                                const blob = new Blob([JSON.stringify({
                                                    query: kqlQuery,
                                                    queryResults: queryResults,
                                                    aiAnalysis: aiResults,
                                                    timestamp: new Date().toISOString()
                                                }, null, 2)], { type: 'application/json' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `ai-analysis-${new Date().toISOString().slice(0,10)}.json`;
                                                a.click();
                                            }}>
                                                📥 Export JSON
                                            </button>
                                            
                                            <button className="btn btn-secondary" onClick={() => {
                                                const text = `AI Analysis Report\n${'='.repeat(50)}\n\nWorkspace: ${selectedWorkspace?.workspaceName}\nModel: ${aiResults.metadata?.modelUsed}\nDate: ${new Date().toISOString()}\n\nQuery:\n${kqlQuery}\n\nResults: ${queryResults?.rowCount} rows\n\nAI Analysis:\n${aiResults.response}`;
                                                const blob = new Blob([text], { type: 'text/plain' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `ai-analysis-${new Date().toISOString().slice(0,10)}.txt`;
                                                a.click();
                                            }}>
                                                📄 Export Text
                                            </button>
                                        </div>
                                        )}
                                    </>
                                ) : (
                                    <div style={{ 
                                        padding: '40px', 
                                        textAlign: 'center', 
                                        color: 'var(--text-secondary)' 
                                    }}>
                                        No analysis results available. Complete the AI Analysis step first.
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                if (activeWorkflow === 'azure' && activeSubBlade === 'query') {
                    return (
                        <div className="blade-content">
                            <div className="blade-header">
                                <div className="blade-icon">📊</div>
                                <div className="blade-title-section">
                                    <h2>KQL Query</h2>
                                    <div className="blade-description">Execute Kusto queries on Log Analytics data</div>
                                </div>
                            </div>

                            <div className="section">
                                <h3 className="section-title">Query Configuration</h3>
                                
                                <div className="form-group">
                                    <label className="form-label">Selected Workspace</label>
                                    <div style={{ padding: '10px', background: 'var(--bg-secondary)', borderRadius: '4px' }}>
                                        {selectedWorkspace ? (
                                            <div>
                                                <strong>{selectedWorkspace.workspaceName}</strong>
                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                                    {selectedWorkspace.resourceGroup} | {selectedWorkspace.location}
                                                </div>
                                            </div>
                                        ) : (
                                            <span style={{ color: 'var(--text-muted)' }}>No workspace selected</span>
                                        )}
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">KQL Query</label>
                                    <textarea 
                                        className="form-textarea"
                                        value={kqlQuery}
                                        onChange={(e) => setKqlQuery(e.target.value)}
                                        placeholder="Enter your KQL query here..."
                                    />
                                </div>

                                <div className="btn-group">
                                    <button 
                                        className="btn btn-success" 
                                        onClick={executeKQLQuery}
                                        disabled={loading || !selectedWorkspace || !kqlQuery}
                                    >
                                        {loading ? (
                                            <>
                                                <div className="loading-spinner"></div>
                                                Executing...
                                            </>
                                        ) : (
                                            '▶️ Execute Query'
                                        )}
                                    </button>
                                </div>
                            </div>

                            {queryResults && (
                                <div className="results-container">
                                    <div className="results-header">
                                        <div>
                                            <div className="results-title">Query Results</div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                                {queryResults.rowCount} rows returned in {queryResults.executionTime?.toFixed(2)}s
                                            </div>
                                        </div>
                                        <div className="btn-group" style={{ marginLeft: 'auto' }}>
                                            <button className="btn btn-sm btn-secondary" onClick={async () => {
                                                try {
                                                    const response = await fetch(`${API_BASE_URL}/export/csv`, {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                            'Authorization': `Bearer ${accessToken}`
                                                        },
                                                        body: JSON.stringify({
                                                            data: queryResults.result,
                                                            metadata: {
                                                                workspace: selectedWorkspace?.workspaceName,
                                                                query: kqlQuery,
                                                                timestamp: new Date().toISOString()
                                                            },
                                                            options: {
                                                                filename: `kql-results-${Date.now()}.csv`
                                                            }
                                                        })
                                                    });
                                                    
                                                    const blob = await response.blob();
                                                    const url = URL.createObjectURL(blob);
                                                    const a = document.createElement('a');
                                                    a.href = url;
                                                    a.download = `kql-results-${new Date().toISOString().slice(0,10)}.csv`;
                                                    a.click();
                                                } catch (error) {
                                                    console.error('Export failed:', error);
                                                    setError('Failed to export to CSV');
                                                }
                                            }}>📊 CSV</button>
                                            
                                            <button className="btn btn-sm btn-secondary" onClick={async () => {
                                                try {
                                                    const response = await fetch(`${API_BASE_URL}/export/excel`, {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                            'Authorization': `Bearer ${accessToken}`
                                                        },
                                                        body: JSON.stringify({
                                                            data: queryResults.result,
                                                            metadata: {
                                                                workspace: selectedWorkspace?.workspaceName,
                                                                query: kqlQuery,
                                                                executionTime: queryResults.executionTime,
                                                                timestamp: new Date().toISOString()
                                                            }
                                                        })
                                                    });
                                                    
                                                    const blob = await response.blob();
                                                    const url = URL.createObjectURL(blob);
                                                    const a = document.createElement('a');
                                                    a.href = url;
                                                    a.download = `kql-results-${new Date().toISOString().slice(0,10)}.xlsx`;
                                                    a.click();
                                                } catch (error) {
                                                    console.error('Export failed:', error);
                                                    setError('Failed to export to Excel');
                                                }
                                            }}>📗 Excel</button>
                                            
                                            <button className="btn btn-sm btn-secondary" onClick={() => {
                                                const blob = new Blob([JSON.stringify(queryResults, null, 2)], { type: 'application/json' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `kql-results-${new Date().toISOString().slice(0,10)}.json`;
                                                a.click();
                                            }}>📥 JSON</button>
                                        </div>
                                    </div>
                                    <div className="results-content">
                                        <pre>{JSON.stringify(queryResults.result, null, 2)}</pre>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }

                // M365 Defender workflow
                if (activeWorkflow === 'm365') {
                    return (
                        <div className="blade-content">
                            <div className="blade-header">
                                <div className="blade-icon">🛡️</div>
                                <div className="blade-title-section">
                                    <h2>Microsoft 365 Defender</h2>
                                    <div className="blade-description">Security incidents, alerts, and threat hunting</div>
                                </div>
                            </div>

                            {m365Error && (
                                <div className="error-message">
                                    <span>❌</span>
                                    <div>
                                        <div style={{ fontWeight: 'bold' }}>Error</div>
                                        <div>{m365Error}</div>
                                    </div>
                                </div>
                            )}

                            <div className="section">
                                <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
                                    <button 
                                        className={`btn ${m365ActiveTab === 'incidents' ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setM365ActiveTab('incidents')}
                                    >
                                        Incidents
                                    </button>
                                    <button 
                                        className={`btn ${m365ActiveTab === 'alerts' ? 'btn-primary' : 'btn-secondary'}`}
                                        onClick={() => setM365ActiveTab('alerts')}
                                    >
                                        Alerts
                                    </button>
                                </div>

                                {m365ActiveTab === 'incidents' && (
                                    <div>
                                        <h3 className="section-title">Security Incidents</h3>
                                        
                                        {/* Data Source Selector */}
                                        <div style={{ 
                                            padding: '12px',
                                            marginBottom: '15px',
                                            background: 'var(--bg-secondary)',
                                            borderRadius: '6px',
                                            border: '1px solid var(--border-primary)'
                                        }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                                                <label style={{ fontWeight: 'bold', fontSize: '13px' }}>Data Source:</label>
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '5px', cursor: 'pointer' }}>
                                                    <input 
                                                        type="radio" 
                                                        name="dataSource" 
                                                        value="sentinel"
                                                        checked={m365DataSource === 'sentinel'}
                                                        onChange={(e) => setM365DataSource(e.target.value)}
                                                    />
                                                    <span>Azure Sentinel (Log Analytics)</span>
                                                </label>
                                                <label style={{ display: 'flex', alignItems: 'center', gap: '5px', cursor: 'pointer' }}>
                                                    <input 
                                                        type="radio" 
                                                        name="dataSource" 
                                                        value="graph"
                                                        checked={m365DataSource === 'graph'}
                                                        onChange={(e) => setM365DataSource(e.target.value)}
                                                    />
                                                    <span>Microsoft Graph API (Direct)</span>
                                                </label>
                                            </div>
                                            {m365DataSource === 'graph' && (
                                                <div style={{ marginTop: '10px', fontSize: '11px', color: 'var(--success-green)' }}>
                                                    ✅ Graph API provides real-time data with rich evidence details
                                                </div>
                                            )}
                                            {m365DataSource === 'sentinel' && (
                                                <div style={{ marginTop: '10px', fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                    ℹ️ Sentinel requires a Log Analytics workspace with SecurityIncident table
                                                </div>
                                            )}
                                        </div>
                                        
                                        {m365DataSource === 'sentinel' && !selectedWorkspace && (
                                            <div style={{ 
                                                padding: '12px',
                                                marginBottom: '15px',
                                                background: '#e3f2fd',
                                                border: '1px solid #90caf9',
                                                borderRadius: '4px',
                                                fontSize: '14px',
                                                color: '#1565c0'
                                            }}>
                                                ℹ️ Please select a Log Analytics workspace from the Azure Data workflow first. 
                                                M365 Defender incidents are queried from Azure Sentinel tables.
                                            </div>
                                        )}
                                        
                                        {selectedWorkspace && (
                                            <div style={{ 
                                                padding: '8px',
                                                marginBottom: '10px',
                                                background: 'var(--bg-secondary)',
                                                borderRadius: '4px',
                                                fontSize: '12px'
                                            }}>
                                                Using workspace: <strong>{selectedWorkspace.workspaceName}</strong>
                                            </div>
                                        )}
                                        
                                        {m365Error && (
                                            <div className="error-message" style={{ marginBottom: '10px' }}>{m365Error}</div>
                                        )}
                                        
                                        <button 
                                            className="btn btn-primary"
                                            onClick={fetchM365Incidents}
                                            disabled={m365Loading || (m365DataSource === 'sentinel' && !selectedWorkspace)}
                                        >
                                            {m365Loading ? 'Loading...' : 'Fetch Incidents'}
                                        </button>
                                        
                                        {m365Incidents.length > 0 && (
                                            <div style={{ marginTop: '20px' }}>
                                                <div className="results-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                    <div>Found {m365Incidents.length} incidents</div>
                                                    <div className="btn-group">
                                                        <button className="btn btn-sm btn-secondary" onClick={async () => {
                                                            try {
                                                                const response = await fetch(`${API_BASE_URL}/export/csv`, {
                                                                    method: 'POST',
                                                                    headers: {
                                                                        'Content-Type': 'application/json',
                                                                        'Authorization': `Bearer ${accessToken}`
                                                                    },
                                                                    body: JSON.stringify({
                                                                        data: m365Incidents,
                                                                        options: { filename: `m365-incidents-${Date.now()}.csv` }
                                                                    })
                                                                });
                                                                const blob = await response.blob();
                                                                const url = URL.createObjectURL(blob);
                                                                const a = document.createElement('a');
                                                                a.href = url;
                                                                a.download = `m365-incidents-${new Date().toISOString().slice(0,10)}.csv`;
                                                                a.click();
                                                            } catch (error) {
                                                                console.error('Export failed:', error);
                                                                setM365Error('Failed to export to CSV');
                                                            }
                                                        }}>📊 CSV</button>
                                                        
                                                        <button className="btn btn-sm btn-secondary" onClick={async () => {
                                                            try {
                                                                const response = await fetch(`${API_BASE_URL}/export/excel`, {
                                                                    method: 'POST',
                                                                    headers: {
                                                                        'Content-Type': 'application/json',
                                                                        'Authorization': `Bearer ${accessToken}`
                                                                    },
                                                                    body: JSON.stringify({
                                                                        data: m365Incidents,
                                                                        metadata: {
                                                                            workspace: selectedWorkspace?.workspaceName,
                                                                            timestamp: new Date().toISOString(),
                                                                            totalIncidents: m365Incidents.length
                                                                        }
                                                                    })
                                                                });
                                                                const blob = await response.blob();
                                                                const url = URL.createObjectURL(blob);
                                                                const a = document.createElement('a');
                                                                a.href = url;
                                                                a.download = `m365-incidents-${new Date().toISOString().slice(0,10)}.xlsx`;
                                                                a.click();
                                                            } catch (error) {
                                                                console.error('Export failed:', error);
                                                                setM365Error('Failed to export to Excel');
                                                            }
                                                        }}>📗 Excel</button>
                                                        
                                                        <button className="btn btn-sm btn-secondary" onClick={async () => {
                                                            try {
                                                                const response = await fetch(`${API_BASE_URL}/export/pdf`, {
                                                                    method: 'POST',
                                                                    headers: {
                                                                        'Content-Type': 'application/json',
                                                                        'Authorization': `Bearer ${accessToken}`
                                                                    },
                                                                    body: JSON.stringify({
                                                                        data: m365Incidents,
                                                                        metadata: {
                                                                            workspace: selectedWorkspace?.workspaceName,
                                                                            timestamp: new Date().toISOString()
                                                                        },
                                                                        options: {
                                                                            title: 'M365 Defender Incidents Report'
                                                                        }
                                                                    })
                                                                });
                                                                const blob = await response.blob();
                                                                const url = URL.createObjectURL(blob);
                                                                const a = document.createElement('a');
                                                                a.href = url;
                                                                a.download = `m365-incidents-${new Date().toISOString().slice(0,10)}.pdf`;
                                                                a.click();
                                                            } catch (error) {
                                                                console.error('Export failed:', error);
                                                                setM365Error('Failed to export to PDF');
                                                            }
                                                        }}>📄 PDF</button>
                                                        
                                                        <button className="btn btn-sm btn-secondary" onClick={() => {
                                                            const blob = new Blob([JSON.stringify(m365Incidents, null, 2)], { type: 'application/json' });
                                                            const url = URL.createObjectURL(blob);
                                                            const a = document.createElement('a');
                                                            a.href = url;
                                                            a.download = `m365-incidents-${new Date().toISOString().slice(0,10)}.json`;
                                                            a.click();
                                                        }}>📥 JSON</button>
                                                    </div>
                                                </div>
                                                <div className="results-container">
                                                    {m365Incidents.map(incident => (
                                                        <div key={incident.id || incident.incidentNumber} className="result-item" style={{ 
                                                            padding: '12px',
                                                            marginBottom: '10px',
                                                            border: '1px solid var(--border-color)',
                                                            borderRadius: '4px',
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            setSelectedIncident(incident);
                                                            setShowIncidentModal(true);
                                                            fetchIncidentDetails(incident);
                                                        }}>
                                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                                <div>
                                                                    <strong>{incident.title || incident.name || `Incident ${incident.incidentNumber}`}</strong>
                                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                                                        #{incident.incidentNumber} | Severity: {incident.severity} | Status: {incident.status}
                                                                    </div>
                                                                    {incident.classification && (
                                                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                                            Classification: {incident.classification}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <div style={{ textAlign: 'right', fontSize: '12px' }}>
                                                                    <div style={{ color: incident.alerts > 0 ? 'var(--text-primary)' : 'var(--text-secondary)' }}>
                                                                        🔔 Alerts: {incident.alerts || 0}
                                                                    </div>
                                                                    <div style={{ color: incident.devices > 0 ? 'var(--text-primary)' : 'var(--text-secondary)' }}>
                                                                        💻 Devices: {incident.devices || 0}
                                                                    </div>
                                                                    <div style={{ color: incident.users > 0 ? 'var(--text-primary)' : 'var(--text-secondary)' }}>
                                                                        👤 Users: {incident.users || 0}
                                                                    </div>
                                                                    {incident.ips > 0 && (
                                                                        <div style={{ color: 'var(--text-primary)' }}>
                                                                            🌐 IPs: {incident.ips}
                                                                        </div>
                                                                    )}
                                                                    {incident.files > 0 && (
                                                                        <div style={{ color: 'var(--text-primary)' }}>
                                                                            📁 Files: {incident.files}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {m365ActiveTab === 'alerts' && (
                                    <div>
                                        <h3 className="section-title">Security Alerts</h3>
                                        <button 
                                            className="btn btn-primary"
                                            onClick={() => fetchM365Alerts()}
                                            disabled={m365Loading}
                                        >
                                            {m365Loading ? 'Loading...' : 'Fetch All Alerts'}
                                        </button>
                                        
                                        {selectedIncident && (
                                            <div style={{ marginTop: '10px', padding: '10px', background: 'var(--bg-secondary)', borderRadius: '4px' }}>
                                                Showing alerts for incident: <strong>{selectedIncident.name}</strong>
                                            </div>
                                        )}
                                        
                                        {m365Alerts.length > 0 && (
                                            <div style={{ marginTop: '20px' }}>
                                                <div className="results-header">
                                                    Found {m365Alerts.length} alerts
                                                </div>
                                                <div className="results-container" style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                                    {m365Alerts.map(alert => (
                                                        <div key={alert.id} className="result-item" style={{ 
                                                            padding: '12px',
                                                            marginBottom: '10px',
                                                            border: '1px solid var(--border-color)',
                                                            borderRadius: '4px'
                                                        }}>
                                                            <strong>{alert.title}</strong>
                                                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                                                {alert.description}
                                                            </div>
                                                            <div style={{ fontSize: '11px', marginTop: '8px' }}>
                                                                Severity: {alert.severity} | Category: {alert.category} | Status: {alert.status}
                                                            </div>
                                                            {alert.evidence && (
                                                                <div style={{ fontSize: '11px', marginTop: '4px' }}>
                                                                    Evidence: Files({alert.evidence.files}) Processes({alert.evidence.processes}) 
                                                                    Users({alert.evidence.users}) Devices({alert.evidence.devices})
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                // Default content for other blades
                return (
                    <div className="blade-content">
                        <div className="section">
                            <h3>{activeWorkflow} - {activeSubBlade}</h3>
                            <p style={{ color: 'var(--text-secondary)' }}>
                                This blade is under development.
                            </p>
                        </div>
                    </div>
                );
            };

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="header-title">
                            <h1>
                                <span style={{ fontSize: '28px' }}>🚀</span>
                                AI Icarus
                            </h1>
                            <div className="header-subtitle">PowerShell-Inspired Navigation</div>
                        </div>
                    </header>

                    <div className="main-container">
                        <nav className="nav-sidebar">
                            <div className="nav-section">
                                <div className="nav-section-title">WORKFLOWS</div>
                                
                                <button 
                                    className={`workflow-btn ${activeWorkflow === 'azure' ? 'active' : ''}`}
                                    onClick={() => setActiveWorkflow('azure')}
                                >
                                    <span>🔷</span>
                                    Azure Analytics
                                </button>
                                
                                {activeWorkflow === 'azure' && (
                                    <div className="workflow-steps">
                                        <div className="step-label">Azure Workflow Steps:</div>
                                        <button 
                                            className={`step-btn ${activeSubBlade === 'setup' ? 'active' : ''}`}
                                            onClick={() => setActiveSubBlade('setup')}
                                        >
                                            1. Setup
                                        </button>
                                        <button 
                                            className={`step-btn ${activeSubBlade === 'query' ? 'active' : ''}`}
                                            onClick={() => setActiveSubBlade('query')}
                                            disabled={workflowStatus.azure.query === 'locked'}
                                        >
                                            2. KQL Query
                                        </button>
                                        <button 
                                            className={`step-btn ${activeSubBlade === 'analysis' ? 'active' : ''}`}
                                            onClick={() => setActiveSubBlade('analysis')}
                                            disabled={workflowStatus.azure.analysis === 'locked'}
                                        >
                                            3. AI Analysis
                                        </button>
                                        <button 
                                            className={`step-btn ${activeSubBlade === 'review' ? 'active' : ''}`}
                                            onClick={() => setActiveSubBlade('review')}
                                            disabled={workflowStatus.azure.review === 'locked'}
                                        >
                                            4. Review
                                        </button>
                                    </div>
                                )}

                                <button 
                                    className={`workflow-btn ${activeWorkflow === 'localFile' ? 'active' : ''}`}
                                    onClick={() => setActiveWorkflow('localFile')}
                                >
                                    <span>📄</span>
                                    Local File Analytics
                                </button>

                                <button 
                                    className={`workflow-btn ${activeWorkflow === 'm365' ? 'active' : ''}`}
                                    onClick={() => setActiveWorkflow('m365')}
                                >
                                    <span>🛡️</span>
                                    M365 Defender
                                </button>
                            </div>

                            <div className="nav-section">
                                <div className="nav-section-title">WORKFLOW STATUS</div>
                                <div style={{ padding: '10px', fontSize: '12px', color: 'var(--text-secondary)' }}>
                                    Ready to begin
                                </div>
                                <div style={{ 
                                    padding: '10px', 
                                    background: 'var(--bg-secondary)', 
                                    borderRadius: '4px',
                                    fontSize: '11px',
                                    color: 'var(--success-green)'
                                }}>
                                    PowerShell-Style Token Management: ACTIVE
                                </div>
                            </div>
                        </nav>

                        <div className="content-area">
                            <main className="main-content">
                                {renderBladeContent()}
                            </main>

                            <aside className="status-panel">
                                {/* New Resource Selection Section */}
                                <div className="session-info">
                                    <h3 className="info-title">
                                        <span>🎯</span>
                                        Active Resources
                                    </h3>
                                    
                                    {/* Discover Resources Button */}
                                    <button 
                                        className="btn btn-primary"
                                        onClick={discoverAllResources}
                                        disabled={loading || isDiscovering}
                                        style={{ 
                                            width: '100%', 
                                            marginBottom: '15px',
                                            padding: '8px',
                                            fontSize: '12px'
                                        }}
                                    >
                                        {isDiscovering ? 'Discovering...' : '🔍 Discover Resources'}
                                    </button>
                                    
                                    {/* Workspace Dropdown */}
                                    <div className="info-item" style={{ marginBottom: '15px' }}>
                                        <label className="info-label" style={{ marginBottom: '5px', display: 'block' }}>
                                            Log Analytics Workspace
                                        </label>
                                        <select 
                                            className="form-select"
                                            style={{ 
                                                width: '100%',
                                                padding: '6px',
                                                fontSize: '12px',
                                                background: 'var(--bg-primary)',
                                                color: 'var(--text-primary)',
                                                border: '1px solid var(--border-primary)',
                                                borderRadius: '4px'
                                            }}
                                            value={selectedWorkspace?.workspaceId || ''}
                                            onChange={(e) => {
                                                const workspace = workspaces.find(w => w.workspaceId === e.target.value);
                                                setSelectedWorkspace(workspace);
                                                if (workspace) {
                                                    setWorkflowStatus(prev => ({
                                                        ...prev,
                                                        azure: { ...prev.azure, query: 'pending' }
                                                    }));
                                                }
                                            }}
                                        >
                                            <option value="">-- Select Workspace --</option>
                                            {workspaces.map(workspace => (
                                                <option key={workspace.workspaceId} value={workspace.workspaceId}>
                                                    {workspace.workspaceName}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* OpenAI Resource Dropdown */}
                                    <div className="info-item" style={{ marginBottom: '15px' }}>
                                        <label className="info-label" style={{ marginBottom: '5px', display: 'block' }}>
                                            OpenAI Resource
                                        </label>
                                        <select 
                                            className="form-select"
                                            style={{ 
                                                width: '100%',
                                                padding: '6px',
                                                fontSize: '12px',
                                                background: 'var(--bg-primary)',
                                                color: 'var(--text-primary)',
                                                border: '1px solid var(--border-primary)',
                                                borderRadius: '4px'
                                            }}
                                            value={selectedResource?.id || ''}
                                            onChange={(e) => {
                                                const resource = openAIResources.find(r => r.id === e.target.value);
                                                setSelectedResource(resource);
                                                if (resource) {
                                                    fetchDeployments(resource);
                                                }
                                            }}
                                        >
                                            <option value="">-- Select Resource --</option>
                                            {openAIResources.map(resource => (
                                                <option key={resource.id} value={resource.id}>
                                                    {resource.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Deployment Dropdown */}
                                    <div className="info-item" style={{ marginBottom: '15px' }}>
                                        <label className="info-label" style={{ marginBottom: '5px', display: 'block' }}>
                                            Model Deployment
                                        </label>
                                        <select 
                                            className="form-select"
                                            style={{ 
                                                width: '100%',
                                                padding: '6px',
                                                fontSize: '12px',
                                                background: 'var(--bg-primary)',
                                                color: 'var(--text-primary)',
                                                border: '1px solid var(--border-primary)',
                                                borderRadius: '4px'
                                            }}
                                            value={selectedDeployment || ''}
                                            onChange={(e) => setSelectedDeployment(e.target.value)}
                                            disabled={!selectedResource || deployments.length === 0}
                                        >
                                            <option value="">-- Select Deployment --</option>
                                            {deployments.map(deployment => (
                                                <option key={deployment.name} value={deployment.name}>
                                                    {deployment.name} ({deployment.model})
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="session-info">
                                    <h3 className="info-title">
                                        <span>💻</span>
                                        Session Info
                                    </h3>
                                    <div className="info-item">
                                        <div className="info-label">Connection Status</div>
                                        <div className={`info-value ${isAuthenticated ? 'success' : 'error'}`}>
                                            {isAuthenticated ? 'Connected to Azure' : 'Not Connected'}
                                        </div>
                                    </div>
                                </div>

                                <div className="session-info">
                                    <h3 className="info-title">
                                        <span>💰</span>
                                        TPM Quota Limits
                                    </h3>
                                    <div className="quota-info">
                                        <div className="quota-title">Tenant TPM Quota</div>
                                        <div className="quota-value">60,000</div>
                                        <div className="quota-details">
                                            <div>Tenant quota detected</div>
                                            <div>Subscription: 60,000 TPM (Global)</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="token-budget">
                                    <div className="budget-item">
                                        <span className="budget-label">Token Budget: 128,000 total</span>
                                    </div>
                                    <div className="budget-item">
                                        <span className="budget-label">Available for Data:</span>
                                        <span className="budget-value">45,000</span>
                                    </div>
                                    <div className="budget-item">
                                        <span className="budget-label">System Overhead:</span>
                                        <span className="budget-value">4,200</span>
                                    </div>
                                    <div className="budget-item">
                                        <span className="budget-label">Output Reserved:</span>
                                        <span className="budget-value">4,096</span>
                                    </div>
                                </div>

                                <div className="metrics-grid">
                                    <div className="metric-card">
                                        <div className="metric-label">Workspaces</div>
                                        <div className="metric-value">{stats.totalWorkspaces}</div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="metric-label">Resources</div>
                                        <div className="metric-value">{stats.totalResources}</div>
                                    </div>
                                </div>

                                <div className="session-info">
                                    <h3 className="info-title">
                                        <span>⚡</span>
                                        System Resources
                                    </h3>
                                    <div className="metrics-grid">
                                        <div className="metric-card">
                                            <div className="metric-label">CPU</div>
                                            <div className="metric-value">28.0%</div>
                                        </div>
                                        <div className="metric-card">
                                            <div className="metric-label">Memory</div>
                                            <div className="metric-value">396 MB</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="session-info">
                                    <h3 className="info-title">
                                        <span>📊</span>
                                        Activity Status
                                    </h3>
                                    <div className={`activity-status ${loading ? 'active' : ''}`}>
                                        {loading ? 'Processing...' : 'Ready'}
                                    </div>
                                </div>

                                {isAuthenticated && (
                                    <button className="btn btn-danger" onClick={handleLogout} style={{ width: '100%', marginTop: '20px' }}>
                                        <span>🚪</span>
                                        Logout
                                    </button>
                                )}
                            </aside>
                        </div>
                    </div>
                    
                    {/* Incident Detail Modal */}
                    {showIncidentModal && selectedIncident && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.8)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10000
                        }}>
                            <div style={{
                                background: 'var(--bg-primary)',
                                border: '2px solid var(--azure-blue)',
                                borderRadius: '8px',
                                width: '90%',
                                maxWidth: '1200px',
                                maxHeight: '90vh',
                                overflow: 'hidden',
                                display: 'flex',
                                flexDirection: 'column'
                            }}>
                                {/* Modal Header */}
                                <div style={{
                                    padding: '20px',
                                    borderBottom: '1px solid var(--border-primary)',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <h2 style={{ margin: 0, color: 'var(--text-bright)' }}>
                                            Incident #{selectedIncident.incidentNumber}
                                        </h2>
                                        <p style={{ margin: '5px 0', color: 'var(--text-secondary)' }}>
                                            {selectedIncident.title}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => {
                                            setShowIncidentModal(false);
                                            setIncidentDetails(null);
                                            setIncidentAnalysis(null);
                                            setAiAnalysisResults(null);
                                        }}
                                        style={{
                                            background: 'transparent',
                                            border: '1px solid var(--text-secondary)',
                                            color: 'var(--text-secondary)',
                                            padding: '8px 16px',
                                            borderRadius: '4px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Close
                                    </button>
                                </div>
                                
                                {/* Modal Tabs */}
                                <div style={{
                                    display: 'flex',
                                    borderBottom: '1px solid var(--border-primary)',
                                    padding: '0 20px'
                                }}>
                                    {['Overview', 'Alerts', 'Entities', 'AI Analysis'].map(tab => (
                                        <button
                                            key={tab}
                                            onClick={() => setIncidentModalTab(tab)}
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                color: incidentModalTab === tab ? 'var(--text-bright)' : 'var(--text-secondary)',
                                                padding: '12px 20px',
                                                cursor: 'pointer',
                                                borderBottom: incidentModalTab === tab ? '2px solid var(--azure-blue)' : 'none',
                                                marginBottom: '-1px'
                                            }}
                                        >
                                            {tab}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Modal Content */}
                                <div style={{
                                    flex: 1,
                                    overflow: 'auto',
                                    padding: '20px'
                                }}>
                                    {analysisLoading ? (
                                        <div style={{ textAlign: 'center', padding: '40px' }}>
                                            <div className="loading-spinner"></div>
                                            <p style={{ marginTop: '20px', color: 'var(--text-secondary)' }}>
                                                Analyzing incident and fetching details...
                                            </p>
                                        </div>
                                    ) : incidentDetails?.error ? (
                                        <div style={{
                                            background: 'var(--bg-secondary)',
                                            border: '1px solid var(--error-red)',
                                            borderRadius: '4px',
                                            padding: '20px',
                                            margin: '20px 0'
                                        }}>
                                            <h3 style={{ color: 'var(--error-red)', marginBottom: '10px' }}>
                                                Error Loading Incident Details
                                            </h3>
                                            <p style={{ color: 'var(--text-secondary)' }}>
                                                {incidentDetails.error}
                                            </p>
                                            <button
                                                className="btn btn-primary"
                                                onClick={() => fetchIncidentDetails(selectedIncident)}
                                                style={{ marginTop: '15px' }}
                                            >
                                                Retry
                                            </button>
                                        </div>
                                    ) : (
                                        <>
                                            {incidentModalTab === 'Overview' && (
                                                <div>
                                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                                                        <div className="metric-card">
                                                            <div className="metric-label">Incident Number</div>
                                                            <div className="metric-value">{selectedIncident.incidentNumber}</div>
                                                        </div>
                                                        <div className="metric-card" style={{ gridColumn: 'span 2' }}>
                                                            <div className="metric-label">Incident ID</div>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                <div className="metric-value" style={{ 
                                                                    fontSize: '14px',
                                                                    fontFamily: 'monospace',
                                                                    wordBreak: 'break-all'
                                                                }}>
                                                                    {selectedIncident.id}
                                                                </div>
                                                                <button
                                                                    onClick={() => {
                                                                        navigator.clipboard.writeText(selectedIncident.id);
                                                                        // Simple feedback without external dependencies
                                                                        const btn = event.target;
                                                                        const originalText = btn.textContent;
                                                                        btn.textContent = '✓';
                                                                        setTimeout(() => {
                                                                            btn.textContent = originalText;
                                                                        }, 1500);
                                                                    }}
                                                                    style={{
                                                                        background: 'var(--bg-tertiary)',
                                                                        border: '1px solid var(--border-primary)',
                                                                        borderRadius: '4px',
                                                                        padding: '4px 8px',
                                                                        cursor: 'pointer',
                                                                        fontSize: '12px',
                                                                        color: 'var(--text-secondary)',
                                                                        flexShrink: 0
                                                                    }}
                                                                    title="Copy Incident ID"
                                                                >
                                                                    📋
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div className="metric-card">
                                                            <div className="metric-label">Severity</div>
                                                            <div className="metric-value" style={{ 
                                                                color: selectedIncident.severity === 'High' ? 'var(--error-red)' : 
                                                                      selectedIncident.severity === 'Medium' ? 'var(--warning-orange)' : 
                                                                      'var(--success-green)' 
                                                            }}>
                                                                {selectedIncident.severity}
                                                            </div>
                                                        </div>
                                                        <div className="metric-card">
                                                            <div className="metric-label">Status</div>
                                                            <div className="metric-value">{selectedIncident.status}</div>
                                                        </div>
                                                        <div className="metric-card">
                                                            <div className="metric-label">Classification</div>
                                                            <div className="metric-value">{selectedIncident.classification || 'Under Investigation'}</div>
                                                        </div>
                                                        <div className="metric-card">
                                                            <div className="metric-label">Owner</div>
                                                            <div className="metric-value">{selectedIncident.owner || 'Unassigned'}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    {incidentDetails?.statistics && (
                                                        <div>
                                                            <h3 style={{ color: 'var(--text-bright)', marginBottom: '15px' }}>Impact Summary</h3>
                                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '15px' }}>
                                                                <div className="metric-card">
                                                                    <div className="metric-label">Total Alerts</div>
                                                                    <div className="metric-value">{incidentDetails.statistics.totalAlerts}</div>
                                                                </div>
                                                                <div className="metric-card">
                                                                    <div className="metric-label">Affected Users</div>
                                                                    <div className="metric-value">{incidentDetails.statistics.uniqueUsers}</div>
                                                                </div>
                                                                <div className="metric-card">
                                                                    <div className="metric-label">Affected Devices</div>
                                                                    <div className="metric-value">{incidentDetails.statistics.uniqueDevices}</div>
                                                                </div>
                                                                <div className="metric-card">
                                                                    <div className="metric-label">Unique IPs</div>
                                                                    <div className="metric-value">{incidentDetails.statistics.uniqueIPs}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    <div style={{ marginTop: '30px' }}>
                                                        <h3 style={{ color: 'var(--text-bright)', marginBottom: '15px' }}>Description</h3>
                                                        <p style={{ color: 'var(--text-secondary)', lineHeight: 1.6 }}>
                                                            {selectedIncident.description || 'No description available'}
                                                        </p>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {incidentModalTab === 'Alerts' && (
                                                <div>
                                                    <h3 style={{ color: 'var(--text-bright)', marginBottom: '20px' }}>
                                                        Associated Alerts ({incidentDetails?.alerts?.length || 0})
                                                    </h3>
                                                    {incidentDetails?.alerts?.map((alert, idx) => (
                                                        <AlertCard key={idx} alert={alert} idx={idx} />
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {/* Old implementation - disabled */}
                                            {false && incidentModalTab === 'Alerts' && (
                                                <div>
                                                    <h3 style={{ color: 'var(--text-bright)', marginBottom: '20px' }}>
                                                        Associated Alerts ({incidentDetails?.alerts?.length || 0})
                                                    </h3>
                                                    {incidentDetails?.alerts?.map((alert, idx) => {
                                                        const [isExpanded, setIsExpanded] = React.useState(false);
                                                        
                                                        return (
                                                            <div key={idx} style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-primary)',
                                                                borderRadius: '4px',
                                                                padding: '15px',
                                                                marginBottom: '15px'
                                                            }}>
                                                                {/* Alert Header */}
                                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                                                                    <div style={{ flex: 1 }}>
                                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                            <h4 style={{ color: 'var(--text-bright)', margin: 0 }}>{alert.title || alert.name}</h4>
                                                                            <button
                                                                                onClick={() => setIsExpanded(!isExpanded)}
                                                                                style={{
                                                                                    background: 'var(--bg-tertiary)',
                                                                                    border: '1px solid var(--border-primary)',
                                                                                    borderRadius: '4px',
                                                                                    padding: '2px 8px',
                                                                                    cursor: 'pointer',
                                                                                    fontSize: '12px',
                                                                                    color: 'var(--text-secondary)'
                                                                                }}
                                                                            >
                                                                                {isExpanded ? '▼ Collapse' : '▶ Expand Details'}
                                                                            </button>
                                                                        </div>
                                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginTop: '5px' }}>
                                                                            <span style={{ fontSize: '12px', color: 'var(--text-secondary)', fontFamily: 'monospace' }}>
                                                                                Alert ID: {alert.id || alert.alertId || 'N/A'}
                                                                            </span>
                                                                            {(alert.id || alert.alertId) && (
                                                                                <button
                                                                                    onClick={() => {
                                                                                        navigator.clipboard.writeText(alert.id || alert.alertId);
                                                                                        event.target.textContent = '✓';
                                                                                        setTimeout(() => {
                                                                                            event.target.textContent = '📋';
                                                                                        }, 1500);
                                                                                    }}
                                                                                    style={{
                                                                                        background: 'transparent',
                                                                                        border: 'none',
                                                                                        cursor: 'pointer',
                                                                                        fontSize: '12px',
                                                                                        padding: '2px'
                                                                                    }}
                                                                                    title="Copy Alert ID"
                                                                                >
                                                                                    📋
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    <span className={`severity-badge severity-${(alert.severity || 'medium').toLowerCase()}`}>
                                                                        {alert.severity}
                                                                    </span>
                                                                </div>
                                                                
                                                                {/* Basic Info */}
                                                                <p style={{ color: 'var(--text-secondary)', marginBottom: '10px' }}>
                                                                    {alert.description}
                                                                </p>
                                                                
                                                                <div style={{ display: 'flex', gap: '20px', fontSize: '12px', color: 'var(--text-muted)', flexWrap: 'wrap' }}>
                                                                    <span>🏢 Vendor: {alert.vendor || alert.providerName || 'Unknown'}</span>
                                                                    <span>📦 Product: {alert.product || alert.serviceSource || 'Unknown'}</span>
                                                                    <span>⏰ Time: {new Date(alert.createdDateTime || alert.timeGenerated).toLocaleString()}</span>
                                                                    <span>📊 Category: {alert.category || 'Unknown'}</span>
                                                                    <span>🎯 Status: {alert.status || 'New'}</span>
                                                                </div>
                                                                
                                                                {/* Expandable Details Section */}
                                                                {isExpanded && (
                                                                    <div style={{
                                                                        marginTop: '20px',
                                                                        paddingTop: '20px',
                                                                        borderTop: '1px solid var(--border-secondary)'
                                                                    }}>
                                                                        {/* MITRE ATT&CK Details */}
                                                                        {(alert.mitreTechniques || alert.tactics || alert.techniques) && (
                                                                            <div style={{ marginBottom: '20px' }}>
                                                                                <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🎯 MITRE ATT&CK Framework</h5>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '10px', borderRadius: '4px' }}>
                                                                                    {alert.tactics && (
                                                                                        <div style={{ marginBottom: '8px' }}>
                                                                                            <strong style={{ color: 'var(--text-secondary)' }}>Tactics:</strong>
                                                                                            <span style={{ marginLeft: '10px', color: 'var(--text-muted)' }}>
                                                                                                {Array.isArray(alert.tactics) ? alert.tactics.join(', ') : alert.tactics}
                                                                                            </span>
                                                                                        </div>
                                                                                    )}
                                                                                    {(alert.techniques || alert.mitreTechniques) && (
                                                                                        <div>
                                                                                            <strong style={{ color: 'var(--text-secondary)' }}>Techniques:</strong>
                                                                                            <span style={{ marginLeft: '10px', color: 'var(--text-muted)' }}>
                                                                                                {Array.isArray(alert.techniques || alert.mitreTechniques) 
                                                                                                    ? (alert.techniques || alert.mitreTechniques).join(', ') 
                                                                                                    : (alert.techniques || alert.mitreTechniques)}
                                                                                            </span>
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {/* Detection Details */}
                                                                        <div style={{ marginBottom: '20px' }}>
                                                                            <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🔍 Detection Information</h5>
                                                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Detection Source</div>
                                                                                    <div style={{ color: 'var(--text-secondary)' }}>{alert.detectionSource || alert.vendor || 'Unknown'}</div>
                                                                                </div>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Detection Method</div>
                                                                                    <div style={{ color: 'var(--text-secondary)' }}>{alert.detectionMethod || 'Behavioral Analysis'}</div>
                                                                                </div>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Confidence</div>
                                                                                    <div style={{ color: 'var(--text-secondary)' }}>{alert.confidence || 'High'}</div>
                                                                                </div>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Alert Type</div>
                                                                                    <div style={{ color: 'var(--text-secondary)' }}>{alert.alertType || alert.category || 'Security'}</div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {/* Evidence */}
                                                                        {alert.evidence && (
                                                                            <div style={{ marginBottom: '20px' }}>
                                                                                <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>📋 Evidence</h5>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '10px', borderRadius: '4px' }}>
                                                                                    {typeof alert.evidence === 'object' ? (
                                                                                        <pre style={{ 
                                                                                            color: 'var(--text-muted)', 
                                                                                            fontSize: '11px', 
                                                                                            margin: 0,
                                                                                            whiteSpace: 'pre-wrap',
                                                                                            wordBreak: 'break-word'
                                                                                        }}>
                                                                                            {JSON.stringify(alert.evidence, null, 2)}
                                                                                        </pre>
                                                                                    ) : (
                                                                                        <p style={{ color: 'var(--text-muted)', margin: 0 }}>{alert.evidence}</p>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {/* Affected Entities */}
                                                                        {(alert.userStates || alert.hostStates || alert.networkConnections || alert.processes || alert.fileStates) && (
                                                                            <div style={{ marginBottom: '20px' }}>
                                                                                <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🎯 Affected Entities</h5>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '10px', borderRadius: '4px' }}>
                                                                                    {alert.userStates && alert.userStates.length > 0 && (
                                                                                        <div style={{ marginBottom: '8px' }}>
                                                                                            <strong style={{ color: 'var(--text-secondary)' }}>Users:</strong>
                                                                                            {alert.userStates.map((user, i) => (
                                                                                                <span key={i} style={{ 
                                                                                                    marginLeft: '10px', 
                                                                                                    color: 'var(--text-muted)',
                                                                                                    display: 'inline-block'
                                                                                                }}>
                                                                                                    👤 {user.userPrincipalName || user.accountName || 'Unknown'}
                                                                                                </span>
                                                                                            ))}
                                                                                        </div>
                                                                                    )}
                                                                                    {alert.hostStates && alert.hostStates.length > 0 && (
                                                                                        <div style={{ marginBottom: '8px' }}>
                                                                                            <strong style={{ color: 'var(--text-secondary)' }}>Hosts:</strong>
                                                                                            {alert.hostStates.map((host, i) => (
                                                                                                <span key={i} style={{ 
                                                                                                    marginLeft: '10px', 
                                                                                                    color: 'var(--text-muted)',
                                                                                                    display: 'inline-block'
                                                                                                }}>
                                                                                                    💻 {host.fqdn || host.netBiosName || 'Unknown'}
                                                                                                </span>
                                                                                            ))}
                                                                                        </div>
                                                                                    )}
                                                                                    {alert.processes && alert.processes.length > 0 && (
                                                                                        <div style={{ marginBottom: '8px' }}>
                                                                                            <strong style={{ color: 'var(--text-secondary)' }}>Processes:</strong>
                                                                                            {alert.processes.map((proc, i) => (
                                                                                                <span key={i} style={{ 
                                                                                                    marginLeft: '10px', 
                                                                                                    color: 'var(--text-muted)',
                                                                                                    display: 'inline-block',
                                                                                                    fontFamily: 'monospace',
                                                                                                    fontSize: '11px'
                                                                                                }}>
                                                                                                    ⚙️ {proc.fileName || proc.name || 'Unknown'}
                                                                                                </span>
                                                                                            ))}
                                                                                        </div>
                                                                                    )}
                                                                                    {alert.fileStates && alert.fileStates.length > 0 && (
                                                                                        <div>
                                                                                            <strong style={{ color: 'var(--text-secondary)' }}>Files:</strong>
                                                                                            {alert.fileStates.map((file, i) => (
                                                                                                <span key={i} style={{ 
                                                                                                    marginLeft: '10px', 
                                                                                                    color: 'var(--text-muted)',
                                                                                                    display: 'inline-block',
                                                                                                    fontFamily: 'monospace',
                                                                                                    fontSize: '11px'
                                                                                                }}>
                                                                                                    📄 {file.name || file.path || 'Unknown'}
                                                                                                </span>
                                                                                            ))}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {/* Remediation Actions */}
                                                                        {(alert.recommendedActions || alert.remediation) && (
                                                                            <div style={{ marginBottom: '20px' }}>
                                                                                <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>🛠️ Recommended Actions</h5>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '10px', borderRadius: '4px' }}>
                                                                                    <ul style={{ margin: 0, paddingLeft: '20px', color: 'var(--text-muted)' }}>
                                                                                        {(alert.recommendedActions || alert.remediation || ['Investigate the alert', 'Review affected entities', 'Check for similar patterns']).map((action, i) => (
                                                                                            <li key={i} style={{ marginBottom: '5px' }}>{action}</li>
                                                                                        ))}
                                                                                    </ul>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {/* Additional Metadata */}
                                                                        <div style={{ marginBottom: '20px' }}>
                                                                            <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>📊 Additional Information</h5>
                                                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '10px' }}>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>First Activity</div>
                                                                                    <div style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>
                                                                                        {alert.firstActivityDateTime ? new Date(alert.firstActivityDateTime).toLocaleString() : 'N/A'}
                                                                                    </div>
                                                                                </div>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Last Activity</div>
                                                                                    <div style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>
                                                                                        {alert.lastActivityDateTime ? new Date(alert.lastActivityDateTime).toLocaleString() : 'N/A'}
                                                                                    </div>
                                                                                </div>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Resolution Status</div>
                                                                                    <div style={{ color: 'var(--text-secondary)' }}>{alert.resolutionStatus || 'Unresolved'}</div>
                                                                                </div>
                                                                                <div style={{ background: 'var(--bg-tertiary)', padding: '8px', borderRadius: '4px' }}>
                                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>Investigation State</div>
                                                                                    <div style={{ color: 'var(--text-secondary)' }}>{alert.investigationState || 'Not Started'}</div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {/* Raw Data (Optional) */}
                                                                        {alert.rawData && (
                                                                            <details style={{ marginTop: '20px' }}>
                                                                                <summary style={{ 
                                                                                    cursor: 'pointer', 
                                                                                    color: 'var(--text-secondary)',
                                                                                    marginBottom: '10px'
                                                                                }}>
                                                                                    📝 View Raw Alert Data
                                                                                </summary>
                                                                                <pre style={{ 
                                                                                    background: 'var(--bg-tertiary)', 
                                                                                    padding: '10px', 
                                                                                    borderRadius: '4px',
                                                                                    color: 'var(--text-muted)',
                                                                                    fontSize: '10px',
                                                                                    overflow: 'auto',
                                                                                    maxHeight: '300px'
                                                                                }}>
                                                                                    {JSON.stringify(alert, null, 2)}
                                                                                </pre>
                                                                            </details>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                            
                                            {incidentModalTab === 'Entities' && (
                                                <div>
                                                    <h3 style={{ color: 'var(--text-bright)', marginBottom: '20px' }}>
                                                        Affected Entities
                                                    </h3>
                                                    
                                                    {incidentDetails?.entities?.users?.length > 0 && (
                                                        <div style={{ marginBottom: '30px' }}>
                                                            <h4 style={{ color: 'var(--text-secondary)', marginBottom: '10px' }}>
                                                                Users ({incidentDetails.entities.users.length})
                                                            </h4>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
                                                                {incidentDetails.entities.users.map((user, idx) => (
                                                                    <span key={idx} className="entity-badge">
                                                                        👤 {user.userPrincipalName || user.accountName || user.domainName || user.name || user.Name || 'Unknown'}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {incidentDetails?.entities?.devices?.length > 0 && (
                                                        <div style={{ marginBottom: '30px' }}>
                                                            <h4 style={{ color: 'var(--text-secondary)', marginBottom: '10px' }}>
                                                                Devices ({incidentDetails.entities.devices.length})
                                                            </h4>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
                                                                {incidentDetails.entities.devices.map((device, idx) => (
                                                                    <span key={idx} className="entity-badge">
                                                                        💻 {device.deviceName || device.hostName || device.name || device.Name || 'Unknown'}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {incidentDetails?.entities?.ips?.length > 0 && (
                                                        <div style={{ marginBottom: '30px' }}>
                                                            <h4 style={{ color: 'var(--text-secondary)', marginBottom: '10px' }}>
                                                                IP Addresses ({incidentDetails.entities.ips.length})
                                                            </h4>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
                                                                {incidentDetails.entities.ips.map((ip, idx) => (
                                                                    <span key={idx} className="entity-badge">
                                                                        🌐 {ip.name || ip.ipAddress || ip.Address || 'Unknown'}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {incidentModalTab === 'AI Analysis' && (
                                                <div>
                                                    <h3 style={{ color: 'var(--text-bright)', marginBottom: '20px' }}>
                                                        AI-Powered Analysis
                                                    </h3>
                                                    {console.log('Current aiAnalysisResults:', aiAnalysisResults)}
                                                    {aiAnalysisResults && aiAnalysisResults.executiveSummary ? (
                                                        <div>
                                                            {/* Executive Summary */}
                                                            <div style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-primary)',
                                                                borderRadius: '4px',
                                                                padding: '20px',
                                                                marginBottom: '20px'
                                                            }}>
                                                                <h4 style={{ color: 'var(--text-bright)', marginBottom: '15px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                    <span>📊</span> {aiAnalysisResults.executiveSummary?.title || 'Executive Summary'}
                                                                </h4>
                                                                <p style={{ color: 'var(--text-secondary)', marginBottom: '15px', lineHeight: 1.6 }}>
                                                                    {aiAnalysisResults.executiveSummary?.content}
                                                                </p>
                                                                <div style={{ marginTop: '15px' }}>
                                                                    <div style={{ marginBottom: '10px' }}>
                                                                        <strong style={{ color: 'var(--text-bright)' }}>Business Impact:</strong>
                                                                        <p style={{ color: 'var(--text-secondary)', marginTop: '5px' }}>
                                                                            {aiAnalysisResults.executiveSummary?.businessImpact}
                                                                        </p>
                                                                    </div>
                                                                    <div>
                                                                        <div style={{ 
                                                                            display: 'inline-block',
                                                                            padding: '5px 15px',
                                                                            borderRadius: '20px',
                                                                            background: (aiAnalysisResults.executiveSummary?.riskLevel?.level === 'Critical' || aiAnalysisResults.executiveSummary?.riskLevel === 'Critical') ? 'rgba(255, 0, 0, 0.2)' :
                                                                                       (aiAnalysisResults.executiveSummary?.riskLevel?.level === 'High' || aiAnalysisResults.executiveSummary?.riskLevel === 'High') ? 'rgba(255, 165, 0, 0.2)' :
                                                                                       (aiAnalysisResults.executiveSummary?.riskLevel?.level === 'Medium' || aiAnalysisResults.executiveSummary?.riskLevel === 'Medium') ? 'rgba(255, 255, 0, 0.2)' :
                                                                                       'rgba(0, 255, 0, 0.2)',
                                                                            color: (aiAnalysisResults.executiveSummary?.riskLevel?.level === 'Critical' || aiAnalysisResults.executiveSummary?.riskLevel === 'Critical') ? '#ff4444' :
                                                                                   (aiAnalysisResults.executiveSummary?.riskLevel?.level === 'High' || aiAnalysisResults.executiveSummary?.riskLevel === 'High') ? '#ff8800' :
                                                                                   (aiAnalysisResults.executiveSummary?.riskLevel?.level === 'Medium' || aiAnalysisResults.executiveSummary?.riskLevel === 'Medium') ? '#ffbb00' :
                                                                                   '#00ff00',
                                                                            cursor: 'pointer'
                                                                        }} onClick={() => {
                                                                            const details = document.getElementById('riskBreakdown');
                                                                            if (details) {
                                                                                details.style.display = details.style.display === 'none' ? 'block' : 'none';
                                                                            }
                                                                        }}>
                                                                            Risk: {aiAnalysisResults.executiveSummary?.riskLevel?.level || aiAnalysisResults.executiveSummary?.riskLevel} 
                                                                            {aiAnalysisResults.executiveSummary?.riskLevel?.score && ` (${aiAnalysisResults.executiveSummary?.riskLevel?.score}/100)`}
                                                                            <span style={{ marginLeft: '10px', fontSize: '11px' }}>▼</span>
                                                                        </div>
                                                                        
                                                                        {/* Risk Score Breakdown */}
                                                                        {aiAnalysisResults.executiveSummary?.riskLevel?.breakdown && (
                                                                            <div id="riskBreakdown" style={{ 
                                                                                display: 'none',
                                                                                marginTop: '15px',
                                                                                padding: '15px',
                                                                                background: 'var(--bg-tertiary)',
                                                                                borderRadius: '4px',
                                                                                border: '1px solid var(--border-primary)'
                                                                            }}>
                                                                                <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>📊 Risk Score Analysis</h5>
                                                                                
                                                                                {/* Progress bar */}
                                                                                <div style={{ 
                                                                                    background: 'var(--bg-secondary)',
                                                                                    height: '30px',
                                                                                    borderRadius: '4px',
                                                                                    marginBottom: '15px',
                                                                                    position: 'relative',
                                                                                    overflow: 'hidden'
                                                                                }}>
                                                                                    <div style={{
                                                                                        background: aiAnalysisResults.executiveSummary?.riskLevel?.score >= 80 ? 'var(--error-red)' :
                                                                                                   aiAnalysisResults.executiveSummary?.riskLevel?.score >= 60 ? '#ff9800' :
                                                                                                   aiAnalysisResults.executiveSummary?.riskLevel?.score >= 40 ? '#ffeb3b' :
                                                                                                   '#00ff00',
                                                                                        width: `${Math.min(100, aiAnalysisResults.executiveSummary?.riskLevel?.percentage || 0)}%`,
                                                                                        height: '100%',
                                                                                        transition: 'width 0.5s ease'
                                                                                    }}>
                                                                                        <span style={{ 
                                                                                            position: 'absolute',
                                                                                            left: '50%',
                                                                                            top: '50%',
                                                                                            transform: 'translate(-50%, -50%)',
                                                                                            fontWeight: 'bold',
                                                                                            color: 'white',
                                                                                            textShadow: '1px 1px 2px rgba(0,0,0,0.5)'
                                                                                        }}>
                                                                                            {aiAnalysisResults.executiveSummary?.riskLevel?.score}/100
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                                
                                                                                {/* Breakdown factors */}
                                                                                <div style={{ marginBottom: '15px' }}>
                                                                                    {aiAnalysisResults.executiveSummary?.riskLevel?.breakdown?.map((factor, idx) => (
                                                                                        <div key={idx} style={{ 
                                                                                            marginBottom: '10px',
                                                                                            padding: '10px',
                                                                                            background: 'var(--bg-secondary)',
                                                                                            borderRadius: '4px',
                                                                                            display: 'flex',
                                                                                            justifyContent: 'space-between',
                                                                                            alignItems: 'center'
                                                                                        }}>
                                                                                            <div style={{ flex: 1 }}>
                                                                                                <strong style={{ color: 'var(--text-bright)' }}>{factor.factor}:</strong>
                                                                                                <span style={{ marginLeft: '10px', color: 'var(--text-secondary)' }}>{factor.value}</span>
                                                                                                <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '3px' }}>
                                                                                                    {factor.explanation}
                                                                                                </div>
                                                                                            </div>
                                                                                            <div style={{ 
                                                                                                background: factor.points >= 30 ? 'rgba(255, 0, 0, 0.2)' :
                                                                                                           factor.points >= 20 ? 'rgba(255, 152, 0, 0.2)' :
                                                                                                           factor.points >= 10 ? 'rgba(255, 235, 59, 0.2)' :
                                                                                                           'rgba(0, 255, 0, 0.2)',
                                                                                                color: factor.points >= 30 ? '#ff4444' :
                                                                                                       factor.points >= 20 ? '#ff8800' :
                                                                                                       factor.points >= 10 ? '#ffbb00' :
                                                                                                       '#00ff00',
                                                                                                padding: '4px 8px',
                                                                                                borderRadius: '4px',
                                                                                                fontWeight: 'bold',
                                                                                                minWidth: '50px',
                                                                                                textAlign: 'center'
                                                                                            }}>
                                                                                                +{factor.points}
                                                                                            </div>
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                                
                                                                                {/* Risk description */}
                                                                                {aiAnalysisResults.executiveSummary?.riskLevel?.description && (
                                                                                    <div style={{ 
                                                                                        padding: '10px',
                                                                                        background: 'var(--bg-secondary)',
                                                                                        borderRadius: '4px',
                                                                                        marginBottom: '10px'
                                                                                    }}>
                                                                                        <strong style={{ color: 'var(--text-bright)' }}>⚠️ Assessment:</strong>
                                                                                        <p style={{ color: 'var(--text-secondary)', margin: '5px 0 0 0' }}>
                                                                                            {aiAnalysisResults.executiveSummary?.riskLevel?.description}
                                                                                        </p>
                                                                                    </div>
                                                                                )}
                                                                                
                                                                                {/* Recommendation */}
                                                                                {aiAnalysisResults.executiveSummary?.riskLevel?.recommendation && (
                                                                                    <div style={{ 
                                                                                        padding: '10px',
                                                                                        background: 'var(--bg-secondary)',
                                                                                        borderRadius: '4px',
                                                                                        borderLeft: '3px solid var(--azure-blue)'
                                                                                    }}>
                                                                                        <strong style={{ color: 'var(--text-bright)' }}>💡 Recommended Action:</strong>
                                                                                        <p style={{ color: 'var(--text-secondary)', margin: '5px 0 0 0' }}>
                                                                                            {aiAnalysisResults.executiveSummary?.riskLevel?.recommendation}
                                                                                        </p>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Technical Analysis */}
                                                            <div style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-primary)',
                                                                borderRadius: '4px',
                                                                padding: '20px',
                                                                marginBottom: '20px'
                                                            }}>
                                                                <h4 style={{ color: 'var(--text-bright)', marginBottom: '15px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                    <span>🔬</span> {aiAnalysisResults.technicalAnalysis?.title || 'Technical Analysis'}
                                                                </h4>
                                                                
                                                                {/* Attack Chain */}
                                                                {aiAnalysisResults.technicalAnalysis?.attackChain?.length > 0 && (
                                                                    <div style={{ marginBottom: '20px' }}>
                                                                        <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>Attack Chain</h5>
                                                                        {aiAnalysisResults.technicalAnalysis.attackChain.map((step, idx) => (
                                                                            <div key={idx} style={{
                                                                                display: 'flex',
                                                                                gap: '15px',
                                                                                marginBottom: '10px',
                                                                                padding: '10px',
                                                                                background: 'var(--bg-primary)',
                                                                                borderRadius: '4px',
                                                                                alignItems: 'center'
                                                                            }}>
                                                                                <span style={{
                                                                                    background: 'var(--primary-color)',
                                                                                    color: 'white',
                                                                                    borderRadius: '50%',
                                                                                    width: '24px',
                                                                                    height: '24px',
                                                                                    display: 'flex',
                                                                                    alignItems: 'center',
                                                                                    justifyContent: 'center',
                                                                                    fontSize: '12px',
                                                                                    flexShrink: 0
                                                                                }}>
                                                                                    {step.step}
                                                                                </span>
                                                                                <div style={{ flex: 1 }}>
                                                                                    <div style={{ color: 'var(--text-bright)' }}>{step.action}</div>
                                                                                    <div style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>
                                                                                        {step.category} • {step.severity}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Timeline with Narrative View */}
                                                                <div style={{ marginBottom: '15px' }}>
                                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                                                        <h5 style={{ color: 'var(--text-bright)' }}>Timeline Analysis</h5>
                                                                        <button 
                                                                            onClick={() => setTimelineView(timelineView === 'narrative' ? 'technical' : 'narrative')}
                                                                            style={{
                                                                                background: 'var(--primary-color)',
                                                                                color: 'white',
                                                                                border: 'none',
                                                                                padding: '4px 12px',
                                                                                borderRadius: '4px',
                                                                                fontSize: '12px',
                                                                                cursor: 'pointer'
                                                                            }}
                                                                        >
                                                                            {timelineView === 'narrative' ? '🔧 Technical View' : '📖 Narrative View'}
                                                                        </button>
                                                                    </div>
                                                                    
                                                                    {timelineView === 'narrative' && aiAnalysisResults.technicalAnalysis?.timelineStory ? (
                                                                        <div style={{
                                                                            background: 'rgba(0, 0, 0, 0.3)',
                                                                            padding: '15px',
                                                                            borderRadius: '4px',
                                                                            fontFamily: 'monospace',
                                                                            fontSize: '13px',
                                                                            lineHeight: '1.6',
                                                                            whiteSpace: 'pre-wrap',
                                                                            maxHeight: '400px',
                                                                            overflowY: 'auto',
                                                                            border: '1px solid var(--primary-color)'
                                                                        }}>
                                                                            {aiAnalysisResults.technicalAnalysis.timelineStory}
                                                                        </div>
                                                                    ) : timelineView === 'narrative' ? (
                                                                        <div style={{ 
                                                                            color: 'var(--text-secondary)',
                                                                            padding: '20px',
                                                                            textAlign: 'center',
                                                                            background: 'rgba(0, 0, 0, 0.3)',
                                                                            borderRadius: '4px'
                                                                        }}>
                                                                            No narrative timeline available. The AI is processing the incident timeline...
                                                                        </div>
                                                                    ) : (
                                                                        <div>
                                                                            {/* Show actual timeline from incident details if available */}
                                                                            {incidentDetails?.timeline?.length > 0 ? (
                                                                                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                                                                    {incidentDetails.timeline.map((event, idx) => (
                                                                                        <div key={idx} style={{
                                                                                            display: 'flex',
                                                                                            gap: '20px',
                                                                                            marginBottom: '20px',
                                                                                            paddingLeft: '30px',
                                                                                            borderLeft: '2px solid var(--border-primary)',
                                                                                            position: 'relative'
                                                                                        }}>
                                                                                            <div style={{
                                                                                                position: 'absolute',
                                                                                                left: '-10px',
                                                                                                top: '0',
                                                                                                width: '18px',
                                                                                                height: '18px',
                                                                                                borderRadius: '50%',
                                                                                                background: event.severity === 'high' || event.severity === 'High' ? 'var(--error-red)' : 
                                                                                                           event.severity === 'medium' || event.severity === 'Medium' ? 'var(--warning-orange)' : 
                                                                                                           'var(--success-green)',
                                                                                                border: '3px solid var(--bg-primary)'
                                                                                            }}></div>
                                                                                            <div style={{ flex: 1 }}>
                                                                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                                                                    <strong style={{ color: 'var(--text-bright)', fontSize: '14px' }}>
                                                                                                        {event.title}
                                                                                                    </strong>
                                                                                                    <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>
                                                                                                        {new Date(event.timestamp).toLocaleString()}
                                                                                                    </span>
                                                                                                </div>
                                                                                                {event.description && (
                                                                                                    <p style={{ color: 'var(--text-secondary)', margin: '0', fontSize: '13px' }}>
                                                                                                        {event.description}
                                                                                                    </p>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            ) : (
                                                                                <>
                                                                                    {/* Technical Timeline (existing) */}
                                                                                    <p style={{ color: 'var(--text-secondary)' }}>
                                                                                        {aiAnalysisResults.technicalAnalysis?.timeline}
                                                                                    </p>
                                                                                    
                                                                                    {/* Show raw attack chain if no narrative available */}
                                                                                    {!aiAnalysisResults.technicalAnalysis?.narrativeTimeline && (
                                                                                        <div style={{ 
                                                                                            marginTop: '10px',
                                                                                            padding: '10px',
                                                                                            background: 'var(--bg-primary)',
                                                                                            borderRadius: '4px',
                                                                                            border: '1px solid var(--border-secondary)'
                                                                                        }}>
                                                                                            <p style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>
                                                                                                💡 Tip: The narrative timeline provides a human-readable story of the attack. 
                                                                                                Currently showing technical view with {aiAnalysisResults.technicalAnalysis?.attackChain?.length || 0} events.
                                                                                            </p>
                                                                                        </div>
                                                                                    )}
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                
                                                                {/* MITRE Tactics */}
                                                                {aiAnalysisResults.technicalAnalysis?.tactics?.length > 0 && (
                                                                    <div>
                                                                        <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>MITRE ATT&CK Tactics</h5>
                                                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
                                                                            {aiAnalysisResults.technicalAnalysis.tactics.map((tactic, idx) => (
                                                                                <span key={idx} style={{
                                                                                    background: 'var(--primary-color)',
                                                                                    color: 'white',
                                                                                    padding: '4px 12px',
                                                                                    borderRadius: '4px',
                                                                                    fontSize: '12px'
                                                                                }}>
                                                                                    {tactic}
                                                                                </span>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Threat Intelligence */}
                                                            <div style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-primary)',
                                                                borderRadius: '4px',
                                                                padding: '20px',
                                                                marginBottom: '20px'
                                                            }}>
                                                                <h4 style={{ color: 'var(--text-bright)', marginBottom: '15px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                    <span>🕵️</span> {aiAnalysisResults.threatIntelligence?.title || 'Threat Intelligence'}
                                                                </h4>
                                                                <div style={{ marginBottom: '15px' }}>
                                                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>Threat Actor Assessment</h5>
                                                                    <p style={{ color: 'var(--text-secondary)' }}>
                                                                        {aiAnalysisResults.threatIntelligence?.threatActors}
                                                                    </p>
                                                                </div>
                                                                <div style={{ marginBottom: '15px' }}>
                                                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>Known Patterns</h5>
                                                                    {Array.isArray(aiAnalysisResults.threatIntelligence?.knownPatterns) ? (
                                                                        <ul style={{ color: 'var(--text-secondary)', marginLeft: '20px' }}>
                                                                            {aiAnalysisResults.threatIntelligence.knownPatterns.map((pattern, idx) => (
                                                                                <li key={idx}>{pattern}</li>
                                                                            ))}
                                                                        </ul>
                                                                    ) : (
                                                                        <p style={{ color: 'var(--text-secondary)' }}>
                                                                            {aiAnalysisResults.threatIntelligence?.knownPatterns}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                                <div>
                                                                    <h5 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>IOC Correlation</h5>
                                                                    <div style={{ color: 'var(--text-secondary)', whiteSpace: 'pre-line' }}>
                                                                        {aiAnalysisResults.threatIntelligence?.iocCorrelation}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Recommendations */}
                                                            <div style={{
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-primary)',
                                                                borderRadius: '4px',
                                                                padding: '20px'
                                                            }}>
                                                                <h4 style={{ color: 'var(--text-bright)', marginBottom: '15px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                                    <span>💡</span> {aiAnalysisResults.recommendations?.title || 'Recommendations'}
                                                                </h4>
                                                                
                                                                {aiAnalysisResults.recommendations?.immediate?.length > 0 && (
                                                                    <div style={{ marginBottom: '20px' }}>
                                                                        <h5 style={{ color: '#ff4444', marginBottom: '10px' }}>⚡ Immediate Actions</h5>
                                                                        <ul style={{ color: 'var(--text-secondary)', marginLeft: '20px' }}>
                                                                            {aiAnalysisResults.recommendations.immediate.map((action, idx) => (
                                                                                <li key={idx}>{action}</li>
                                                                            ))}
                                                                        </ul>
                                                                    </div>
                                                                )}
                                                                
                                                                {aiAnalysisResults.recommendations?.shortTerm?.length > 0 && (
                                                                    <div style={{ marginBottom: '20px' }}>
                                                                        <h5 style={{ color: '#ff8800', marginBottom: '10px' }}>📅 Short-term Actions</h5>
                                                                        <ul style={{ color: 'var(--text-secondary)', marginLeft: '20px' }}>
                                                                            {aiAnalysisResults.recommendations.shortTerm.map((action, idx) => (
                                                                                <li key={idx}>{action}</li>
                                                                            ))}
                                                                        </ul>
                                                                    </div>
                                                                )}
                                                                
                                                                {aiAnalysisResults.recommendations?.preventive?.length > 0 && (
                                                                    <div>
                                                                        <h5 style={{ color: '#00ff00', marginBottom: '10px' }}>🛡️ Preventive Measures</h5>
                                                                        <ul style={{ color: 'var(--text-secondary)', marginLeft: '20px' }}>
                                                                            {aiAnalysisResults.recommendations.preventive.map((measure, idx) => (
                                                                                <li key={idx}>{measure}</li>
                                                                            ))}
                                                                        </ul>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* Confidence Level */}
                                                            <div style={{
                                                                marginTop: '20px',
                                                                padding: '10px',
                                                                background: 'var(--bg-secondary)',
                                                                border: '1px solid var(--border-primary)',
                                                                borderRadius: '4px',
                                                                textAlign: 'center'
                                                            }}>
                                                                <span style={{ color: 'var(--text-secondary)' }}>Analysis Confidence: </span>
                                                                <span style={{
                                                                    color: aiAnalysisResults.confidence === 'High' ? '#00ff00' :
                                                                           aiAnalysisResults.confidence === 'Medium' ? '#ffbb00' :
                                                                           '#ff8800',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {aiAnalysisResults.confidence}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div style={{
                                                            background: 'var(--bg-secondary)',
                                                            border: '1px solid var(--border-primary)',
                                                            borderRadius: '4px',
                                                            padding: '20px'
                                                        }}>
                                                            {!showModelSelection ? (
                                                                <div style={{ textAlign: 'center' }}>
                                                                    <div style={{ fontSize: '48px', marginBottom: '15px' }}>🤖</div>
                                                                    <h4 style={{ color: 'var(--text-bright)', marginBottom: '10px' }}>
                                                                        AI Analysis Available
                                                                    </h4>
                                                                    <p style={{ color: 'var(--text-secondary)', marginBottom: '20px' }}>
                                                                        Click below to generate comprehensive AI analysis including executive summary, 
                                                                        technical details, threat intelligence, and actionable recommendations.
                                                                    </p>
                                                                    <button 
                                                                        className="btn btn-primary"
                                                                        onClick={() => {
                                                                            setShowModelSelection(true);
                                                                            
                                                                            // Use sidebar selections as defaults if available
                                                                            if (selectedResource && !m365SelectedResource) {
                                                                                setM365SelectedResource(selectedResource);
                                                                                // Also load deployments for this resource
                                                                                fetchM365Deployments(selectedResource);
                                                                            }
                                                                            if (selectedDeployment && !m365SelectedDeployment) {
                                                                                setM365SelectedDeployment(selectedDeployment);
                                                                            }
                                                                            
                                                                            // Load OpenAI resources if not already loaded
                                                                            if (openAIResources.length === 0) {
                                                                                discoverOpenAIResources();
                                                                            }
                                                                        }}
                                                                    >
                                                                        Configure AI Model
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <h4 style={{ color: 'var(--text-bright)', marginBottom: '20px' }}>
                                                                        Select AI Model for Analysis
                                                                    </h4>
                                                                    
                                                                    {/* OpenAI Resource Selection */}
                                                                    <div style={{ marginBottom: '20px' }}>
                                                                        <label style={{ color: 'var(--text-secondary)', display: 'block', marginBottom: '10px' }}>
                                                                            OpenAI Resource:
                                                                        </label>
                                                                        <select 
                                                                            value={m365SelectedResource?.name || m365SelectedResource?.id || ''}
                                                                            onChange={(e) => {
                                                                                const resource = openAIResources.find(r => r.name === e.target.value || r.id === e.target.value);
                                                                                setM365SelectedResource(resource);
                                                                                if (resource) {
                                                                                    fetchM365Deployments(resource);
                                                                                }
                                                                            }}
                                                                            style={{
                                                                                width: '100%',
                                                                                padding: '8px',
                                                                                background: 'var(--bg-primary)',
                                                                                color: 'var(--text-primary)',
                                                                                border: '1px solid var(--border-primary)',
                                                                                borderRadius: '4px'
                                                                            }}
                                                                        >
                                                                            <option value="">Select a resource...</option>
                                                                            {openAIResources.map(resource => (
                                                                                <option key={resource.name} value={resource.name}>
                                                                                    {resource.name} ({resource.location})
                                                                                </option>
                                                                            ))}
                                                                        </select>
                                                                    </div>
                                                                    
                                                                    {/* Model Deployment Selection */}
                                                                    {m365SelectedResource && (
                                                                        <div style={{ marginBottom: '20px' }}>
                                                                            <label style={{ color: 'var(--text-secondary)', display: 'block', marginBottom: '10px' }}>
                                                                                Model Deployment:
                                                                            </label>
                                                                            {m365LoadingDeployments ? (
                                                                                <div style={{ color: 'var(--text-secondary)' }}>
                                                                                    Loading deployments...
                                                                                </div>
                                                                            ) : (
                                                                                <select 
                                                                                    value={m365SelectedDeployment || ''}
                                                                                    onChange={(e) => setM365SelectedDeployment(e.target.value)}
                                                                                    style={{
                                                                                        width: '100%',
                                                                                        padding: '8px',
                                                                                        background: 'var(--bg-primary)',
                                                                                        color: 'var(--text-primary)',
                                                                                        border: '1px solid var(--border-primary)',
                                                                                        borderRadius: '4px'
                                                                                    }}
                                                                                    disabled={m365Deployments.length === 0}
                                                                                >
                                                                                    <option value="">Select a deployment...</option>
                                                                                    {m365Deployments.map(deployment => (
                                                                                        <option key={deployment.name} value={deployment.name}>
                                                                                            {deployment.name} ({deployment.model} - {deployment.status})
                                                                                        </option>
                                                                                    ))}
                                                                                </select>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                    
                                                                    {/* Action Buttons */}
                                                                    <div style={{ display: 'flex', gap: '10px', justifyContent: 'center' }}>
                                                                        <button 
                                                                            className="btn btn-secondary"
                                                                            onClick={() => setShowModelSelection(false)}
                                                                        >
                                                                            Cancel
                                                                        </button>
                                                                        <button 
                                                                            className="btn btn-primary"
                                                                            onClick={async () => {
                                                                                if (!m365SelectedResource || !m365SelectedDeployment) {
                                                                                    setError('Please select both a resource and deployment');
                                                                                    return;
                                                                                }
                                                                                
                                                                                setAnalysisLoading(true);
                                                                                setAiAnalysisResults(null);
                                                                                try {
                                                                                    const token = await window.acquireTokenSafe();
                                                                                    const response = await fetch('https://ai-icarus-dev1-func.azurewebsites.net/api/m365-defender-graph', {
                                                                                        method: 'POST',
                                                                                        headers: {
                                                                                            'Content-Type': 'application/json',
                                                                                            'Authorization': `Bearer ${token}`
                                                                                        },
                                                                                        body: JSON.stringify({
                                                                                            action: 'ai-analysis',
                                                                                            incidentId: selectedIncident.id,
                                                                                            resourceName: m365SelectedResource.name,
                                                                                            deploymentName: m365SelectedDeployment,
                                                                                            incidentData: incidentDetails
                                                                                        })
                                                                                    });
                                                                                    
                                                                                    if (!response.ok) {
                                                                                        throw new Error(`Failed to generate AI analysis: ${response.statusText}`);
                                                                                    }
                                                                                    
                                                                                    const data = await response.json();
                                                                                    console.log('AI Analysis Response:', data);
                                                                                    setAiAnalysisResults(data);
                                                                                    setShowModelSelection(false);
                                                                                } catch (error) {
                                                                                    console.error('Error generating AI analysis:', error);
                                                                                    setError('Failed to generate AI analysis: ' + error.message);
                                                                                } finally {
                                                                                    setAnalysisLoading(false);
                                                                                }
                                                                            }}
                                                                            disabled={analysisLoading || !m365SelectedDeployment}
                                                                        >
                                                                            {analysisLoading ? 'Generating Analysis...' : 'Generate AI Analysis'}
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<AIIcarusApp />, document.getElementById('root'));
    </script>
</body>
</html>